<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MatchingProps | Plataforma Inmobiliaria Inteligente</title>
  
  <!-- 🎯 FAVICON - MatchingProps Logo Real -->
  <link rel="icon" type="image/png" href="https://i.imgur.com/P01UmJk.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/P01UmJk.png">
  <meta name="theme-color" content="#273030">
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg {
      background: linear-gradient(135deg, #273030 0%, #3a4a4a 100%);
    }
    .glass-effect {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .section-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
    }
    .form-input {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px 16px;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    .form-input:focus {
      border-color: #273030;
      box-shadow: 0 0 0 3px rgba(39, 48, 48, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #273030 0%, #3a4a4a 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #1a2020 0%, #2d3d3d 100%);
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(39, 48, 48, 0.3);
    }
    .sidebar-item {
      border-radius: 10px;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .sidebar-item:hover {
      background: rgba(39, 48, 48, 0.1);
      color: #273030;
    }
    .sidebar-item.active {
      background: #273030;
      color: white;
    }
    .form-section {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      background: #fafafa;
    }
    .form-section h3 {
      color: #374151;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }
    .form-section h4 {
      color: #374151;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid #d1d5db;
    }
    .multi-select-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .multi-select-item {
      background: #f3f4f6;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    .multi-select-item.selected {
      background: #273030;
      color: white;
      border-color: #273030;
    }
    .multi-select-item:hover {
      border-color: #273030;
    }
    
    /* ✅ NUEVO: Estilos para penalizaciones en tablas */
    .penalty-red {
      background-color: #fee2e2 !important;
      color: #991b1b !important;
      font-weight: 600;
    }
    
    .penalty-yellow {
      background-color: #fef3c7 !important;
      color: #92400e !important;
      font-weight: 600;
    }
    
    .penalty-normal {
      background-color: inherit;
      color: inherit;
    }
    
    /* Estilos para el logo MatchingProps® */
    .logo-main {
      font-family: 'League Spartan', sans-serif;
      font-weight: 800;
      font-size: 2.5rem;
      color: white;
      text-transform: lowercase;
      letter-spacing: -0.02em;
      position: relative;
      display: inline-block;
    }
    
    .logo-main::after {
      content: '®';
      font-size: 0.6em;
      vertical-align: super;
      margin-left: 2px;
      font-weight: 600;
    }
    
    .logo-sidebar {
      font-family: 'League Spartan', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      color: #1f2937;
      text-transform: lowercase;
      letter-spacing: -0.02em;
      position: relative;
      display: inline-block;
    }
    
    .logo-sidebar::after {
      content: '®';
      font-size: 0.6em;
      vertical-align: super;
      margin-left: 2px;
      font-weight: 600;
      color: #1f2937;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ✅ Multi-environment API detection
    const API_BASE = (() => {
      const hostname = window.location.hostname;
      
      // Test environment detection
      if (hostname.includes('test') || hostname.includes('flame')) {
        return "https://matchingprops-backend-test.onrender.com"; // ← URL de tu backend test
      }
      
      // Production environment (mantener URL actual)
      return "https://matchingprops.onrender.com"; // ← Tu URL de backend producción actual
    })();
    
    // ✅ Environment indicator for debugging
    console.log(`🌍 Environment: ${API_BASE.includes('test') ? 'TEST' : 'PRODUCTION'}`);
    console.log(`📡 API Base: ${API_BASE}`);
    let token = null;
    let companiaId = null;

    // Multi-Select Component
    // Multi-Select Component
    const MultiSelect = ({ label, name, options, value, onChange, required = false }) => {
      const handleItemClick = (option) => {
        const currentValues = Array.isArray(value) ? value : [];
        const isSelected = currentValues.includes(option);
        
        let newValues;
        if (isSelected) {
          newValues = currentValues.filter(v => v !== option);
        } else {
          newValues = [...currentValues, option];
        }
        
        onChange({ target: { name, value: newValues } });
      };

      return (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            {label} {required && '*'}
          </label>
          <div className="multi-select-container">
            {options.map(option => (
              <div
                key={option}
                className={`multi-select-item ${Array.isArray(value) && value.includes(option) ? 'selected' : ''}`}
                onClick={() => handleItemClick(option)}
              >
                {option}
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Sidebar Component
    // Sidebar Component
    const Sidebar = ({ activeSection, setActiveSection, userRole }) => (
      <div className="fixed left-0 top-0 w-72 h-screen bg-white border-r border-gray-200 p-6 z-10">
        <div className="mb-8">
          {/* 
          ============================================
          BRANDING TEMPORALMENTE OCULTO
          Descomentar las siguientes líneas cuando termine el período de prueba
          ============================================
          <h2 className="logo-sidebar">matchingprops</h2>
          <p className="text-sm text-gray-500 mt-1">Plataforma Inmobiliaria Inteligente</p>
          ============================================
          */}
          <div className="mt-2 px-2 py-1 bg-gray-100 rounded text-xs text-gray-600">
            Rol: {userRole}
          </div>
        </div>
        
        <nav className="space-y-2">
          {[
            { id: 'clientes', label: 'Registrar Cliente', icon: '👤', roles: ['Asesor', 'Supervisor'] },
            { id: 'pisos', label: 'Registrar Piso', icon: '🏡', roles: ['Asesor', 'Supervisor'] },
            { id: 'searchClientes', label: 'Buscar Clientes', icon: '🔍', roles: ['Asesor', 'Supervisor'] },
            { id: 'searchPisos', label: 'Buscar Pisos', icon: '🏢', roles: ['Asesor', 'Supervisor'] },
            { id: 'gestionClientes', label: 'Gestión de Clientes', icon: '👥', roles: ['Asesor', 'Supervisor'] },
            { id: 'gestionPisos', label: 'Gestión de Pisos', icon: '🏗️', roles: ['Supervisor'] }
          ].filter(item => item.roles.includes(userRole)).map(item => (
            <button
              key={item.id}
              onClick={() => setActiveSection(item.id)}
              className={`w-full text-left p-3 sidebar-item ${activeSection === item.id ? 'active' : ''}`}
            >
              <span className="mr-3 text-lg">{item.icon}</span>
              {item.label}
            </button>
          ))}
        </nav>
      </div>
    );

    // Login Component
    const LoginForm = ({ onLogin }) => {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        
        try {
          const response = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ username: email, password }),
          });
          const data = await response.json();
          
          if (response.ok) {
            token = data.access_token;
            const payload = JSON.parse(atob(data.access_token.split(".")[1]));
            companiaId = payload.compania_id;
            onLogin();
          } else {
            alert("Credenciales incorrectas. Por favor, inténtalo de nuevo.");
          }
        } catch (error) {
          alert("Error de conexión. Inténtalo más tarde.");
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen gradient-bg flex items-center justify-center p-6">
          <div className="w-full max-w-md">
            {/* 
        ============================================
        BRANDING TEMPORALMENTE OCULTO
        Descomentar las siguientes líneas cuando termine el período de prueba
        ============================================
        <div className="text-center mb-8">
          <h1 className="logo-main mb-2">matchingprops</h1>
          <p className="text-white/80">Plataforma Inmobiliaria Inteligente</p>
        </div>
        ============================================
        */}
            
            <div className="glass-effect rounded-2xl p-8">
              <h2 className="text-2xl font-semibold text-white mb-6 text-center">Iniciar Sesión</h2>
              
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="Correo electrónico"
                    className="w-full form-input bg-white/90 text-gray-900 placeholder-gray-500"
                    required
                  />
                </div>
                
                <div>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="Contraseña"
                    className="w-full form-input bg-white/90 text-gray-900 placeholder-gray-500"
                    required
                  />
                </div>
                
                <button 
                  type="submit" 
                  disabled={loading}
                  className="w-full btn-primary py-4 text-lg font-semibold disabled:opacity-50"
                >
                  {loading ? "Iniciando sesión..." : "Entrar"}
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    };

    // Client Form Component
    const ClientForm = ({ onRegister }) => {
      const [formData, setFormData] = useState({
        nombre: "", telefono: "", zona: [], subzonas: "", entrada: "", precio: "",
        tipo_vivienda: [], finalidad: [], habitaciones: [], estado: [],
        ascensor: "", bajos: "", entreplanta: "", m2: "", altura: [], cercania_metro: "", 
        balcon_terraza: "", patio: "", interior: "",
        caracteristicas_adicionales: "", banco: "", permuta: "", kiron: ""
      });
    
      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
      };
    
      const handleSubmit = async (e) => {
        e.preventDefault();
        const cliente = { 
          ...formData, 
          compania_id: companiaId, 
          entrada: parseFloat(formData.entrada), 
          precio: parseFloat(formData.precio), 
          m2: parseInt(formData.m2), 
          habitaciones: Array.isArray(formData.habitaciones) ? formData.habitaciones.map(Number) : [],
          zona: Array.isArray(formData.zona) ? formData.zona : [],
          tipo_vivienda: Array.isArray(formData.tipo_vivienda) ? formData.tipo_vivienda : [],
          finalidad: Array.isArray(formData.finalidad) ? formData.finalidad : [],
          estado: Array.isArray(formData.estado) ? formData.estado : [],
          altura: Array.isArray(formData.altura) ? formData.altura : []
        };
        
        // Validación antes del envío
        if (!cliente.nombre || !cliente.telefono) {
          alert("❌ Nombre y teléfono son obligatorios");
          return;
        }
        if (!cliente.zona || cliente.zona.length === 0) {
          alert("❌ Debe seleccionar al menos una zona");
          return;
        }
        if (!cliente.entrada || !cliente.precio || !cliente.m2) {
          alert("❌ Entrada, precio y metros cuadrados son obligatorios");
          return;
        }
        
        console.log("Enviando cliente:", JSON.stringify(cliente, null, 2)); // Debug
        
        try {
          const response = await fetch(`${API_BASE}/clientes/`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(cliente),
          });
          const result = await response.json();
          
          if (response.ok) {
            alert(`✅ Cliente registrado: ${result.nombre}`);
            setFormData({
              nombre: "", telefono: "", zona: [], subzonas: "", entrada: "", precio: "",
              tipo_vivienda: [], finalidad: [], habitaciones: [], estado: [],
              ascensor: "", bajos: "", entreplanta: "", m2: "", altura: [], cercania_metro: "",
              balcon_terraza: "", patio: "", interior: "",
              caracteristicas_adicionales: "", banco: "", permuta: "", kiron: ""
            });
            onRegister();
          } else {
            console.error("Error response:", result);
            let errorMessage = "Error desconocido";
            
            if (typeof result.detail === 'string') {
              errorMessage = result.detail;
            } else if (typeof result.detail === 'object') {
              errorMessage = JSON.stringify(result.detail, null, 2);
            } else if (result.message) {
              errorMessage = result.message;
            } else {
              errorMessage = `Error ${response.status}: ${response.statusText}`;
            }
            
            alert("❌ Error al registrar cliente:\n" + errorMessage);
          }
        } catch (error) {
          console.error("Network error:", error);
          console.error("Error details:", {
            message: error.message,
            stack: error.stack,
            clienteData: cliente
          });
          alert("❌ Error de conexión: " + error.message + "\nVerifica que el servidor esté funcionando.\nRevisa la consola para más detalles.");
        }
      };
    
      return (
        <div className="section-card p-8">
          <div className="mb-6">
            <h2 className="text-2xl font-semibold text-gray-900 mb-2">👤 Registro de Cliente</h2>
            <p className="text-gray-600">Registra un nuevo cliente en el sistema</p>
          </div>
          
          <form onSubmit={handleSubmit}>
            {/* Información Básica */}
            <div className="form-section">
              <h3>Información Básica</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                  <input
                    name="nombre"
                    value={formData.nombre}
                    onChange={handleChange}
                    placeholder="Nombre completo"
                    className="w-full form-input"
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Teléfono *</label>
                  <input
                    name="telefono"
                    value={formData.telefono}
                    onChange={handleChange}
                    placeholder="Número de teléfono"
                    className="w-full form-input"
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Banco</label>
                  <input
                    name="banco"
                    value={formData.banco}
                    onChange={handleChange}
                    placeholder="Entidad bancaria"
                    className="w-full form-input"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">KÍRON</label>
                  <select
                    name="kiron"
                    value={formData.kiron}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SK">SK</option>
                    <option value="PK">PK</option>
                    <option value="NK">NK</option>
                  </select>
                </div>
              </div>
            </div>
    
            {/* Ubicación */}
            <div className="form-section">
              <h3>Ubicación</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <MultiSelect
                  label="Zona"
                  name="zona"
                  options={["ALTO", "OLIVOS", "LAGUNA", "BATÁN", "SEPÚLVEDA", "MANZANARES", "PÍO", "PUERTA", "JESUITAS"]}
                  value={formData.zona}
                  onChange={handleChange}
                  required={true}
                />
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Subzonas</label>
                  <input
                    name="subzonas"
                    value={formData.subzonas}
                    onChange={handleChange}
                    placeholder="Subzonas específicas"
                    className="w-full form-input"
                  />
                </div>
              </div>
            </div>
    
            {/* Aspectos Económicos */}
            <div className="form-section">
              <h3>Aspectos Económicos</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Entrada *</label>
                  <select
                    name="entrada"
                    value={formData.entrada}
                    onChange={handleChange}
                    className="w-full form-input"
                    required
                  >
                    <option value="">Seleccionar entrada</option>
                    {[...Array(50).keys()].map(i => (
                      <option key={i * 10000 + 10000} value={i * 10000 + 10000}>
                        {(i * 10000 + 10000).toLocaleString()}€
                      </option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Precio *</label>
                  <select
                    name="precio"
                    value={formData.precio}
                    onChange={handleChange}
                    className="w-full form-input"
                    required
                  >
                    <option value="">Seleccionar precio</option>
                    {[...Array(50).keys()].map(i => (
                      <option key={i * 10000 + 10000} value={i * 10000 + 10000}>
                        {(i * 10000 + 10000).toLocaleString()}€
                      </option>
                    ))}
                    {[...Array(25).keys()].map(i => (
                      <option key={520000 + i * 20000} value={520000 + i * 20000}>
                        {(520000 + i * 20000).toLocaleString()}€
                      </option>
                    ))}
                    {[...Array(20).keys()].map(i => (
                      <option key={1050000 + i * 50000} value={1050000 + i * 50000}>
                        {(1050000 + i * 50000).toLocaleString()}€
                      </option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Permuta</label>
                  <select
                    name="permuta"
                    value={formData.permuta}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="NO">NO</option>
                  </select>
                </div>
              </div>
            </div>
    
            {/* Características de la Vivienda */}
            <div className="form-section">
              <h3>Características de la Vivienda</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <MultiSelect
                  label="Tipo de Vivienda"
                  name="tipo_vivienda"
                  options={["Piso", "Ático", "Chalet", "Local"]}
                  value={formData.tipo_vivienda}
                  onChange={handleChange}
                />
                
                <MultiSelect
                  label="Finalidad"
                  name="finalidad"
                  options={["Primera Vivienda", "Inversión"]}
                  value={formData.finalidad}
                  onChange={handleChange}
                />
                
                <MultiSelect
                  label="Habitaciones"
                  name="habitaciones"
                  options={["0", "1", "2", "3", "4", "5"]}
                  value={formData.habitaciones}
                  onChange={handleChange}
                />
                
                <MultiSelect
                  label="Estado"
                  name="estado"
                  options={["Entrar a Vivir", "Actualizar", "A Reformar"]}
                  value={formData.estado}
                  onChange={handleChange}
                />
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Metros² *</label>
                  <input
                    name="m2"
                    type="number"
                    value={formData.m2}
                    onChange={handleChange}
                    placeholder="Metros cuadrados"
                    className="w-full form-input"
                    required
                  />
                </div>
              </div>
            </div>
    
            {/* Ubicación y Acceso */}
            <div className="form-section">
              <h3>Ubicación y Acceso</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Ascensor</label>
                  <select
                    name="ascensor"
                    value={formData.ascensor}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="Después de 1º">Después de 1º</option>
                    <option value="Después de 2º">Después de 2º</option>
                    <option value="Después de 3º">Después de 3º</option>
                    <option value="Después de 4º">Después de 4º</option>
                    <option value="Después de 5º">Después de 5º</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Bajos</label>
                  <select
                    name="bajos"
                    value={formData.bajos}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="NO">NO</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Entreplanta</label>
                  <select
                    name="entreplanta"
                    value={formData.entreplanta}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="NO">NO</option>
                  </select>
                </div>
                
                <MultiSelect
                  label="Altura"
                  name="altura"
                  options={["PRIMERAS PLANTAS", "PLANTAS INTERMEDIAS", "ÚLTIMAS PLANTAS"]}
                  value={formData.altura}
                  onChange={handleChange}
                />
              </div>
            </div>
    
            {/* Transporte */}
            <div className="form-section">
              <h3>Transporte</h3>
              <div className="grid grid-cols-1 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Cercanía Metro</label>
                  <select
                    name="cercania_metro"
                    value={formData.cercania_metro}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="0-5 MIN">0-5 MIN</option>
                    <option value="5-10 MIN">5-10 MIN</option>
                    <option value="10-15 MIN">10-15 MIN</option>
                    <option value="15-20 MIN">15-20 MIN</option>
                    <option value="+20 MIN">+20 MIN</option>
                  </select>
                </div>
              </div>
            </div>
    
            {/* Espacios Exteriores */}
            <div className="form-section">
              <h3>Espacios Exteriores</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Balcón/Terraza</label>
                  <select
                    name="balcon_terraza"
                    value={formData.balcon_terraza}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="INDIFERENTE">INDIFERENTE</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Patio</label>
                  <select
                    name="patio"
                    value={formData.patio}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="INDIFERENTE">INDIFERENTE</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Interior</label>
                  <select
                    name="interior"
                    value={formData.interior}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="EXTERIOR">EXTERIOR</option>
                    <option value="INTERIOR">INTERIOR</option>
                    <option value="INDIFERENTE">INDIFERENTE</option>
                  </select>
                </div>
              </div>
            </div>
    
            {/* Características Adicionales */}
            <div className="form-section">
              <h3>Información Adicional</h3>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Características Adicionales</label>
                <textarea
                  name="caracteristicas_adicionales"
                  value={formData.caracteristicas_adicionales}
                  onChange={handleChange}
                  placeholder="Detalles adicionales sobre las preferencias del cliente..."
                  rows="4"
                  className="w-full form-input"
                />
              </div>
            </div>
            
            <button type="submit" className="btn-primary px-8 py-3 text-lg font-semibold">
              ✅ Registrar Cliente
            </button>
          </form>
        </div>
      );
    };

// Piso Form Component
    const PisoForm = ({ onRegister }) => {
      const [formData, setFormData] = useState({
        direccion: "", zona: "", subzonas: "", precio: "", tipo_vivienda: [], habitaciones: "", estado: "",
        ascensor: "", bajos: "", entreplanta: "", planta: "", m2: "", altura: "", cercania_metro: "",
        balcon_terraza: "", patio: "", interior: "", caracteristicas_adicionales: ""
      });
    
      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
      };
    
      const handleSubmit = async (e) => {
        e.preventDefault();
        const piso = { 
          ...formData, 
          compania_id: companiaId, 
          precio: parseFloat(formData.precio), 
          m2: parseInt(formData.m2), 
          habitaciones: formData.habitaciones ? [parseInt(formData.habitaciones)] : [],
          zona: Array.isArray(formData.zona) ? formData.zona : [formData.zona],
          tipo_vivienda: Array.isArray(formData.tipo_vivienda) ? formData.tipo_vivienda : []
        };
        
        try {
          const response = await fetch(`${API_BASE}/pisos/`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(piso),
          });
          const result = await response.json();
          
          if (response.ok) {
            alert(`✅ Piso registrado con ID: ${result.id}`);
            setFormData({
              direccion: "", zona: "", subzonas: "", precio: "", tipo_vivienda: [], habitaciones: "", estado: "",
              ascensor: "", bajos: "", entreplanta: "", planta: "", m2: "", altura: "", cercania_metro: "",
              balcon_terraza: "", patio: "", interior: "", caracteristicas_adicionales: ""
            });
            onRegister();
          } else {
            console.error("Error response:", result);
            let errorMessage = "Error desconocido";
            
            if (typeof result.detail === 'string') {
              errorMessage = result.detail;
            } else if (typeof result.detail === 'object') {
              errorMessage = JSON.stringify(result.detail, null, 2);
            } else if (result.message) {
              errorMessage = result.message;
            } else {
              errorMessage = `Error ${response.status}: ${response.statusText}`;
            }
            
            alert("❌ Error al registrar piso:\n" + errorMessage);
          }
        } catch (error) {
          alert("❌ Error de conexión: " + error.message);
        }
      };
    
      return (
        <div className="section-card p-8">
          <div className="mb-6">
            <h2 className="text-2xl font-semibold text-gray-900 mb-2">🏡 Registro de Piso</h2>
            <p className="text-gray-600">Registra una nueva propiedad en el sistema</p>
          </div>
          
          <form onSubmit={handleSubmit}>
            {/* Información Básica */}
            <div className="form-section">
              <h3>Información Básica</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Dirección</label>
                  <input
                    name="direccion"
                    value={formData.direccion}
                    onChange={handleChange}
                    placeholder="Dirección completa"
                    className="w-full form-input"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Zona *</label>
                  <select
                    name="zona"
                    value={formData.zona}
                    onChange={handleChange}
                    className="w-full form-input"
                    required
                  >
                    <option value="">Seleccionar zona</option>
                    <option value="ALTO">ALTO</option>
                    <option value="OLIVOS">OLIVOS</option>
                    <option value="LAGUNA">LAGUNA</option>
                    <option value="BATÁN">BATÁN</option>
                    <option value="SEPÚLVEDA">SEPÚLVEDA</option>
                    <option value="MANZANARES">MANZANARES</option>
                    <option value="PÍO">PÍO</option>
                    <option value="PUERTA">PUERTA</option>
                    <option value="JESUITAS">JESUITAS</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Subzonas</label>
                  <input
                    name="subzonas"
                    value={formData.subzonas}
                    onChange={handleChange}
                    placeholder="Subzonas específicas"
                    className="w-full form-input"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Precio (€) *</label>
                  <input
                    name="precio"
                    type="number"
                    value={formData.precio}
                    onChange={handleChange}
                    placeholder="Precio en euros"
                    className="w-full form-input"
                    required
                  />
                </div>
              </div>
            </div>
    
            {/* Características de la Vivienda */}
            <div className="form-section">
              <h3>Características de la Vivienda</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <MultiSelect
                  label="Tipo de Vivienda"
                  name="tipo_vivienda"
                  options={["Piso", "Ático", "Chalet", "Local"]}
                  value={formData.tipo_vivienda}
                  onChange={handleChange}
                />
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Habitaciones</label>
                  <select
                    name="habitaciones"
                    value={formData.habitaciones}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar habitaciones</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Metros² *</label>
                  <input
                    name="m2"
                    type="number"
                    value={formData.m2}
                    onChange={handleChange}
                    placeholder="Metros cuadrados"
                    className="w-full form-input"
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                  <select
                    name="estado"
                    value={formData.estado}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar estado</option>
                    <option value="Entrar a Vivir">Entrar a Vivir</option>
                    <option value="Actualizar">Actualizar</option>
                    <option value="A Reformar">A Reformar</option>
                  </select>
                </div>
              </div>
            </div>
    
            {/* Ubicación y Acceso */}
            <div className="form-section">
              <h3>Ubicación y Acceso</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Ascensor</label>
                  <select
                    name="ascensor"
                    value={formData.ascensor}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="NO">NO</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Bajos</label>
                  <select
                    name="bajos"
                    value={formData.bajos}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="NO">NO</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Entreplanta</label>
                  <select
                    name="entreplanta"
                    value={formData.entreplanta}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="NO">NO</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Planta</label>
                  <select
                    name="planta"
                    value={formData.planta}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar planta</option>
                    <option value="-1">-1</option>
                    <option value="0">0</option>
                    <option value="Entreplanta">Entreplanta</option>
                    {[...Array(15).keys()].map(i => (
                      <option key={i + 1} value={i + 1}>{i + 1}</option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Altura</label>
                  <select
                    name="altura"
                    value={formData.altura}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="PRIMERAS PLANTAS">PRIMERAS PLANTAS</option>
                    <option value="PLANTAS INTERMEDIAS">PLANTAS INTERMEDIAS</option>
                    <option value="ÚLTIMAS PLANTAS">ÚLTIMAS PLANTAS</option>
                  </select>
                </div>
              </div>
            </div>
    
            {/* Transporte */}
            <div className="form-section">
              <h3>Transporte</h3>
              <div className="grid grid-cols-1 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Cercanía Metro</label>
                  <select
                    name="cercania_metro"
                    value={formData.cercania_metro}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="0-5 MIN">0-5 MIN</option>
                    <option value="5-10 MIN">5-10 MIN</option>
                    <option value="10-15 MIN">10-15 MIN</option>
                    <option value="15-20 MIN">15-20 MIN</option>
                    <option value="+20 MIN">+20 MIN</option>
                  </select>
                </div>
              </div>
            </div>
    
            {/* Espacios Exteriores */}
            <div className="form-section">
              <h3>Espacios Exteriores</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Balcón/Terraza</label>
                  <select
                    name="balcon_terraza"
                    value={formData.balcon_terraza}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="NO">NO</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Patio</label>
                  <select
                    name="patio"
                    value={formData.patio}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="SÍ">SÍ</option>
                    <option value="NO">NO</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Interior</label>
                  <select
                    name="interior"
                    value={formData.interior}
                    onChange={handleChange}
                    className="w-full form-input"
                  >
                    <option value="">Seleccionar</option>
                    <option value="EXTERIOR">EXTERIOR</option>
                    <option value="INTERIOR">INTERIOR</option>
                    <option value="AMBOS">AMBOS</option>
                  </select>
                </div>
              </div>
            </div>
    
            {/* Características Adicionales */}
            <div className="form-section">
              <h3>Información Adicional</h3>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Características Adicionales</label>
                <textarea
                  name="caracteristicas_adicionales"
                  value={formData.caracteristicas_adicionales}
                  onChange={handleChange}
                  placeholder="Detalles adicionales sobre la propiedad..."
                  rows="4"
                  className="w-full form-input"
                />
              </div>
            </div>
            
            <button type="submit" className="btn-primary px-8 py-3 text-lg font-semibold">
              ✅ Registrar Piso
            </button>
          </form>
        </div>
      );
    };

    // ✅ NUEVO: Función auxiliar para manejar penalizaciones
    const getPenaltyClass = (penalizaciones, fieldName) => {
      if (!penalizaciones || !penalizaciones[fieldName]) {
        return 'penalty-normal';
      }
      
      const penalty = penalizaciones[fieldName];
      if (penalty.color === 'red') {
        return 'penalty-red';
      } else if (penalty.color === 'yellow') {
        return 'penalty-yellow';
      }
      
      return 'penalty-normal';
    };

    // ✅ NUEVO: Función para obtener valor con estilo aplicado
    const getStyledCellContent = (value, penalizaciones, fieldName) => {
      const className = getPenaltyClass(penalizaciones, fieldName);
      const displayValue = value || 'N/A';
      
      return React.createElement('span', { 
        className: className,
        style: className !== 'penalty-normal' ? { padding: '4px 8px', borderRadius: '4px' } : {}
      }, displayValue);
    };

    // Search Clients Component
    // Search Clients Component - CÓDIGO ACTUALIZADO
    const SearchClientes = ({ userRole = 'Asesor' }) => {
      const [pisos, setPisos] = useState([]);
      const [results, setResults] = useState([]);
      const [clientes, setClientes] = useState([]);
      const [selectedPiso, setSelectedPiso] = useState("");
      const [loading, setLoading] = useState(false);
      const [sortField, setSortField] = useState("score");
      const [sortDirection, setSortDirection] = useState("desc");
      
      // Nuevos estados para manejo de estados de cliente
      const [updatingStates, setUpdatingStates] = useState({});
    
      useEffect(() => {
        fetchPisos();
        fetchClientes(); // Siempre obtener clientes para mostrar información completa
      }, [userRole]);
      
      const fetchClientes = async () => {
        try {
          const response = await fetch(`${API_BASE}/clientes/`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (response.ok) {
            const data = await response.json();
            setClientes(data);
          }
        } catch (error) {
          console.error("Error fetching clientes:", error);
        }
      };
    
      const fetchPisos = async () => {
        try {
          const response = await fetch(`${API_BASE}/pisos/`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          setPisos(data);
        } catch (error) {
          console.error("Error fetching pisos:", error);
          alert("Error al cargar pisos: " + error.message);
        }
      };
    
      const handleSearch = async () => {
        if (!selectedPiso) {
          alert("Por favor, selecciona un piso");
          return;
        }
        
        setLoading(true);
        try {
          const response = await fetch(`${API_BASE}/match/?piso_id=${selectedPiso}`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (!response.ok) {
            const errorData = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorData}`);
          }
          
          const data = await response.json();
          setResults(data);
        } catch (error) {
          console.error("Error searching clientes:", error);
          alert("Error al buscar clientes: " + error.message);
        } finally {
          setLoading(false);
        }
      };

      // Nueva función para actualizar estado de cliente
      const updateClienteEstado = async (clienteId, estado) => {
        if (!selectedPiso) return;
        
        const key = `${clienteId}-${selectedPiso}`;
        setUpdatingStates(prev => ({ ...prev, [key]: true }));
        
        try {
          const response = await fetch(`${API_BASE}/match/estado`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              cliente_id: clienteId,
              piso_id: parseInt(selectedPiso),
              estado: estado
            })
          });
          
          if (response.ok) {
            // Actualizar el estado en results
            setResults(prev => prev.map(result => 
              result.cliente_id === clienteId 
                ? { ...result, estado: estado }
                : result
            ));
          } else {
            const error = await response.json();
            alert('❌ Error al actualizar estado: ' + error.detail);
          }
        } catch (error) {
          console.error('Error updating estado:', error);
          alert('❌ Error de conexión al actualizar estado');
        } finally {
          setUpdatingStates(prev => ({ ...prev, [key]: false }));
        }
      };
    
      // Función para ordenar resultados
      // Función para ordenar resultados
      const sortResults = (field) => {
        const direction = sortField === field && sortDirection === 'asc' ? 'desc' : 'asc';
        setSortField(field);
        setSortDirection(direction);
      
        const sortedResults = [...results].sort((a, b) => {
          const clienteA = clientes.find(c => c.id === a.cliente_id);
          const clienteB = clientes.find(c => c.id === b.cliente_id);
          
          let valueA, valueB;
          
          if (field === 'score') {
            valueA = a.score;
            valueB = b.score;
          } else if (field === 'm2') {
            valueA = clienteA?.m2 || 0;
            valueB = clienteB?.m2 || 0;
          } else if (['precio', 'entrada'].includes(field)) {
            valueA = clienteA?.[field] || 0;
            valueB = clienteB?.[field] || 0;
          } else if (field === 'asesor') {
            valueA = clienteA?.asesor_asignado?.email || '';
            valueB = clienteB?.asesor_asignado?.email || '';
          } else {
            // Para todos los demás campos de texto
            valueA = clienteA?.[field] || '';
            valueB = clienteB?.[field] || '';
          }
      
          // Convertir strings a lowercase para ordenamiento alfabético
          if (typeof valueA === 'string') {
            valueA = valueA.toLowerCase();
            valueB = valueB.toLowerCase();
          }
      
          if (direction === 'asc') {
            return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
          } else {
            return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
          }
        });
      
        setResults(sortedResults);
      };
    
      // Función para obtener el icono de ordenamiento
      const getSortIcon = (field) => {
        if (sortField !== field) return '↕️';
        return sortDirection === 'asc' ? '↑' : '↓';
      };
    
      return (
        <div className="section-card p-8">
          <div className="mb-6">
            <h2 className="text-2xl font-semibold text-gray-900 mb-2">🔍 Buscar Clientes</h2>
            <p className="text-gray-600">Encuentra clientes compatibles para un piso específico</p>
          </div>
          
          <div className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Seleccionar Piso</label>
              <select
                value={selectedPiso}
                onChange={(e) => setSelectedPiso(e.target.value)}
                className="w-full form-input"
              >
                <option value="">Seleccionar un piso...</option>
                {pisos.map(piso => (
                  <option key={piso.id} value={piso.id}>
                    {piso.direccion || `Piso ${piso.id}`} - {piso.zona} - {piso.precio?.toLocaleString()}€
                  </option>
                ))}
              </select>
            </div>
            
            <div className="flex gap-4">
              <button 
                onClick={handleSearch} 
                disabled={loading || !selectedPiso}
                className="btn-primary px-6 py-3 font-semibold disabled:opacity-50"
              >
                {loading ? "Buscando..." : "🔍 Buscar Clientes"}
              </button>
              
              {userRole === 'Supervisor' && (
                <button 
                  onClick={downloadMatchesReport}
                  className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"
                  style={{background: 'linear-gradient(135deg, #273030 0%, #3a4a4a 100%)'}}
                >
                  📊 Descargar Reporte Excel
                </button>
              )}
            </div>
            
            {results.length > 0 && (
              <div className="mt-8">
                <h3 className="text-xl font-semibold text-gray-900 mb-4">
                  Clientes Compatibles ({results.length}) - Ordenados por Compatibilidad
                </h3>
                
                {/* Tabla con scroll horizontal y todas las columnas */}
                <div className="overflow-x-auto border border-gray-300 rounded-lg">
                  <table className="min-w-max border-collapse bg-white">
                    <thead>
                      <tr className="bg-gray-100">
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">
                          Estado
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('score')}
                        >
                          Compatibilidad {getSortIcon('score')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('nombre')}
                        >
                          Nombre {getSortIcon('nombre')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('telefono')}
                        >
                          Teléfono {getSortIcon('telefono')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('asesor')}
                        >
                          Asesor Asignado {getSortIcon('asesor')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('banco')}
                        >
                          Banco {getSortIcon('banco')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('kiron')}
                        >
                          KÍRON {getSortIcon('kiron')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('zona')}
                        >
                          Zona {getSortIcon('zona')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('entrada')}
                        >
                          Entrada {getSortIcon('entrada')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('precio')}
                        >
                          Precio {getSortIcon('precio')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('permuta')}
                        >
                          Permuta {getSortIcon('permuta')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('tipo_vivienda')}
                        >
                          Tipo Vivienda {getSortIcon('tipo_vivienda')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('finalidad')}
                        >
                          Finalidad {getSortIcon('finalidad')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('habitaciones')}
                        >
                          Habitaciones {getSortIcon('habitaciones')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('estado')}
                        >
                          Estado {getSortIcon('estado')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('m2')}
                        >
                          Metros² {getSortIcon('m2')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('ascensor')}
                        >
                          Ascensor {getSortIcon('ascensor')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('bajos')}
                        >
                          Bajos {getSortIcon('bajos')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('entreplanta')}
                        >
                          Entreplanta {getSortIcon('entreplanta')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('altura')}
                        >
                          Altura {getSortIcon('altura')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('cercania_metro')}
                        >
                          Cercanía Metro {getSortIcon('cercania_metro')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('balcon_terraza')}
                        >
                          Balcón/Terraza {getSortIcon('balcon_terraza')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('patio')}
                        >
                          Patio {getSortIcon('patio')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortResults('interior')}
                        >
                          Interior {getSortIcon('interior')}
                        </th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">
                          Características Adicionales
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {results
                        .filter(match => match.estado === 'Pendiente' || match.estado === 'No contesta')
                        .map(match => {
                          const cliente = clientes.find(c => c.id === match.cliente_id);
                          if (!cliente) return null;
                          
                          const updateKey = `${match.cliente_id}-${selectedPiso}`;
                          const isUpdating = updatingStates[updateKey];
                          
                          return (
                            <tr key={match.cliente_id} className="hover:bg-gray-50">
                              <td className="border border-gray-300 px-3 py-2 whitespace-nowrap">
                                <select
                                  value={match.estado}
                                  onChange={(e) => updateClienteEstado(match.cliente_id, e.target.value)}
                                  disabled={isUpdating}
                                  className={`text-xs border border-gray-300 rounded px-2 py-1 ${
                                    match.estado === 'Pendiente' ? 'bg-yellow-50 text-yellow-800' :
                                    match.estado === 'No contesta' ? 'bg-red-50 text-red-800' :
                                    'bg-gray-50'
                                  } ${isUpdating ? 'opacity-50' : ''}`}
                                >
                                  <option value="Pendiente">Pendiente</option>
                                  <option value="Cita Venta Puesta">Cita Venta Puesta</option>
                                  <option value="Descarta">Descarta</option>
                                  <option value="No contesta">No contesta</option>
                                </select>
                                {isUpdating && <div className="text-xs text-gray-500 mt-1">Actualizando...</div>}
                              </td>
                              <td className="border border-gray-300 px-3 py-2">
                              <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                match.score >= 90 ? 'bg-green-100 text-green-800' :
                                match.score >= 80 ? 'bg-blue-100 text-blue-800' :
                                match.score >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                              }`}>
                                {match.score}%
                              </span>
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.nombre}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.telefono}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {cliente.asesor_asignado ? (
                                <span className="text-blue-600 text-xs">
                                  {cliente.asesor_asignado.email}
                                </span>
                              ) : (
                                <span className="text-gray-400 text-xs">Sin asignar</span>
                              )}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.banco || 'N/A'}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.kiron || 'N/A'}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.zona}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.entrada?.toLocaleString()}€</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.precio?.toLocaleString() + '€', match.penalizaciones, 'precio')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.permuta || 'N/A'}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.tipo_vivienda, match.penalizaciones, 'tipo_vivienda')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.finalidad || 'N/A'}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.habitaciones || 'N/A'}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.estado, match.penalizaciones, 'estado')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.m2 + 'm²', match.penalizaciones, 'm2')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.ascensor, match.penalizaciones, 'ascensor')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.bajos, match.penalizaciones, 'bajos')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.entreplanta, match.penalizaciones, 'entreplanta')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.altura, match.penalizaciones, 'altura')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.cercania_metro, match.penalizaciones, 'cercania_metro')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.balcon_terraza, match.penalizaciones, 'balcon_terraza')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.patio, match.penalizaciones, 'patio')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(cliente.interior, match.penalizaciones, 'interior')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 max-w-xs text-sm overflow-hidden text-ellipsis">
                              {cliente.caracteristicas_adicionales || 'N/A'}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
            
            {results.length === 0 && selectedPiso && !loading && (
              <div className="text-center py-8 text-gray-500">
                No se encontraron clientes compatibles para este piso.
              </div>
            )}
            {/* Nueva tabla para clientes con Cita Venta Puesta y Descarta */}
            {results.filter(match => match.estado === 'Cita Venta Puesta' || match.estado === 'Descarta').length > 0 && (
              <div className="mt-8">
                <h4 className="text-lg font-semibold text-gray-900 mb-4">
                  Clientes Gestionados ({results.filter(match => match.estado === 'Cita Venta Puesta' || match.estado === 'Descarta').length})
                </h4>
                
                <div className="overflow-x-auto border border-gray-300 rounded-lg">
                  <table className="min-w-max border-collapse bg-white">
                    <thead>
                      <tr className="bg-gray-100">
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">Estado</th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">Compatibilidad</th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">Nombre</th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">Teléfono</th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">Banco</th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">KÍRON</th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">Asesor Asignado</th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">Entrada</th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">Precio</th>
                      </tr>
                    </thead>
                    <tbody>
                      {results
                        .filter(match => match.estado === 'Cita Venta Puesta' || match.estado === 'Descarta')
                        .map(match => {
                          const cliente = clientes.find(c => c.id === match.cliente_id);
                          if (!cliente) return null;
                          
                          const updateKey = `${match.cliente_id}-${selectedPiso}`;
                          const isUpdating = updatingStates[updateKey];
                          
                          return (
                            <tr key={match.cliente_id} className="hover:bg-gray-50">
                              <td className="border border-gray-300 px-3 py-2 whitespace-nowrap">
                                <select
                                  value={match.estado}
                                  onChange={(e) => updateClienteEstado(match.cliente_id, e.target.value)}
                                  disabled={isUpdating}
                                  className={`text-xs border border-gray-300 rounded px-2 py-1 ${
                                    match.estado === 'Cita Venta Puesta' ? 'bg-green-50 text-green-800' :
                                    match.estado === 'Descarta' ? 'bg-red-50 text-red-800' :
                                    'bg-gray-50'
                                  } ${isUpdating ? 'opacity-50' : ''}`}
                                >
                                  <option value="Pendiente">Pendiente</option>
                                  <option value="Cita Venta Puesta">Cita Venta Puesta</option>
                                  <option value="Descarta">Descarta</option>
                                  <option value="No contesta">No contesta</option>
                                </select>
                                {isUpdating && <div className="text-xs text-gray-500 mt-1">Actualizando...</div>}
                              </td>
                              <td className="border border-gray-300 px-3 py-2">
                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                  match.score >= 90 ? 'bg-green-100 text-green-800' :
                                  match.score >= 80 ? 'bg-blue-100 text-blue-800' :
                                  match.score >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-red-100 text-red-800'
                                }`}>
                                  {match.score}%
                                </span>
                              </td>
                              <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.nombre}</td>
                              <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.telefono}</td>
                              <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.banco || 'N/A'}</td>
                              <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.kiron || 'N/A'}</td>
                              <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                                {cliente.asesor_asignado ? (
                                  <span className="text-blue-600 text-xs">
                                    {cliente.asesor_asignado.email}
                                  </span>
                                ) : (
                                  <span className="text-gray-400 text-xs">Sin asignar</span>
                                )}
                              </td>
                              <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.entrada?.toLocaleString()}€</td>
                              <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{cliente.precio?.toLocaleString()}€</td>
                            </tr>
                          );
                        })}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Search Pisos Component
    // Search Pisos Component - CÓDIGO ACTUALIZADO
    const SearchPisos = () => {
      const [clientes, setClientes] = useState([]);
      const [pisos, setPisos] = useState([]);
      const [results, setResults] = useState([]);
      const [selectedCliente, setSelectedCliente] = useState("");
      const [loading, setLoading] = useState(false);
    
      useEffect(() => {
        fetchClientes();
        fetchPisos(); // Obtener también los pisos para mostrar información completa
      }, []);

            // Estados para ordenamiento de pisos
      const [pisoSortField, setPisoSortField] = useState("score");
      const [pisoSortDirection, setPisoSortDirection] = useState("desc");
      
      // Función para ordenar resultados de pisos
      const sortPisoResults = (field) => {
        const direction = pisoSortField === field && pisoSortDirection === 'asc' ? 'desc' : 'asc';
        setPisoSortField(field);
        setPisoSortDirection(direction);
      
        const sortedResults = [...results].sort((a, b) => {
          const pisoA = pisos.find(p => p.id === a.piso_id);
          const pisoB = pisos.find(p => p.id === b.piso_id);
          
          let valueA, valueB;
          
          if (field === 'score') {
            valueA = a.score;
            valueB = b.score;
          } else if (['precio', 'm2'].includes(field)) {
            valueA = pisoA?.[field] || 0;
            valueB = pisoB?.[field] || 0;
          } else {
            // Para todos los demás campos de texto
            valueA = pisoA?.[field] || '';
            valueB = pisoB?.[field] || '';
          }
      
          // Convertir strings a lowercase para ordenamiento alfabético
          if (typeof valueA === 'string') {
            valueA = valueA.toLowerCase();
            valueB = valueB.toLowerCase();
          }
      
          if (direction === 'asc') {
            return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
          } else {
            return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
          }
        });
      
        setResults(sortedResults);
      };
      
      // Función para obtener el icono de ordenamiento de pisos
      const getPisoSortIcon = (field) => {
        if (pisoSortField !== field) return '↕️';
        return pisoSortDirection === 'asc' ? '↑' : '↓';
      };
    
      const fetchClientes = async () => {
        try {
          const response = await fetch(`${API_BASE}/clientes/`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          setClientes(data);
        } catch (error) {
          console.error("Error fetching clientes:", error);
          alert("Error al cargar clientes: " + error.message);
        }
      };
    
      const fetchPisos = async () => {
        try {
          const response = await fetch(`${API_BASE}/pisos/`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          setPisos(data);
        } catch (error) {
          console.error("Error fetching pisos:", error);
          alert("Error al cargar pisos: " + error.message);
        }
      };
    
      const handleSearch = async () => {
        if (!selectedCliente) {
          alert("Por favor, selecciona un cliente");
          return;
        }
        
        setLoading(true);
        try {
          const response = await fetch(`${API_BASE}/match/?cliente_id=${selectedCliente}`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (!response.ok) {
            const errorData = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorData}`);
          }
          
          const data = await response.json();
          // Los resultados ya vienen ordenados por score (mayor primero)
          setResults(data);
        } catch (error) {
          console.error("Error searching pisos:", error);
          alert("Error al buscar pisos: " + error.message);
        } finally {
          setLoading(false);
        }
      };
    
      return (
        <div className="section-card p-8">
          <div className="mb-6">
            <h2 className="text-2xl font-semibold text-gray-900 mb-2">🏢 Buscar Pisos</h2>
            <p className="text-gray-600">Encuentra propiedades compatibles para un cliente específico</p>
          </div>
          
          <div className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Seleccionar Cliente</label>
              <select
                value={selectedCliente}
                onChange={(e) => setSelectedCliente(e.target.value)}
                className="w-full form-input"
              >
                <option value="">Seleccionar un cliente...</option>
                {clientes.map(cliente => (
                  <option key={cliente.id} value={cliente.id}>
                    {cliente.nombre} - {cliente.telefono} - {cliente.precio?.toLocaleString()}€
                  </option>
                ))}
              </select>
            </div>
            
            <button 
              onClick={handleSearch} 
              disabled={loading || !selectedCliente}
              className="btn-primary px-6 py-3 font-semibold disabled:opacity-50"
            >
              {loading ? "Buscando..." : "🏢 Buscar Pisos"}
            </button>
            
            {results.length > 0 && (
              <div className="mt-8">
                <h3 className="text-xl font-semibold text-gray-900 mb-4">
                  Pisos Compatibles ({results.length}) - Ordenados por Compatibilidad
                </h3>
                
                {/* Tabla con scroll horizontal y todas las columnas */}
                <div className="overflow-x-auto border border-gray-300 rounded-lg">
                  <table className="min-w-max border-collapse bg-white">
                    <thead>
                      <tr className="bg-gray-100">
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('score')}
                        >
                          Compatibilidad {getPisoSortIcon('score')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('direccion')}
                        >
                          Dirección {getPisoSortIcon('direccion')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('zona')}
                        >
                          Zona {getPisoSortIcon('zona')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('subzonas')}
                        >
                          Subzonas {getPisoSortIcon('subzonas')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('precio')}
                        >
                          Precio {getPisoSortIcon('precio')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('m2')}
                        >
                          Metros² {getPisoSortIcon('m2')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('tipo_vivienda')}
                        >
                          Tipo Vivienda {getPisoSortIcon('tipo_vivienda')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('habitaciones')}
                        >
                          Habitaciones {getPisoSortIcon('habitaciones')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('estado')}
                        >
                          Estado {getPisoSortIcon('estado')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('ascensor')}
                        >
                          Ascensor {getPisoSortIcon('ascensor')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('bajos')}
                        >
                          Bajos {getPisoSortIcon('bajos')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('entreplanta')}
                        >
                          Entreplanta {getPisoSortIcon('entreplanta')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('planta')}
                        >
                          Planta {getPisoSortIcon('planta')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('altura')}
                        >
                          Altura {getPisoSortIcon('altura')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('cercania_metro')}
                        >
                          Cercanía Metro {getPisoSortIcon('cercania_metro')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('balcon_terraza')}
                        >
                          Balcón/Terraza {getPisoSortIcon('balcon_terraza')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('patio')}
                        >
                          Patio {getPisoSortIcon('patio')}
                        </th>
                        <th 
                          className="border border-gray-300 px-3 py-2 text-left cursor-pointer hover:bg-gray-200 whitespace-nowrap text-sm font-medium"
                          onClick={() => sortPisoResults('interior')}
                        >
                          Interior {getPisoSortIcon('interior')}
                        </th>
                        <th className="border border-gray-300 px-3 py-2 text-left whitespace-nowrap text-sm font-medium">
                          Características Adicionales
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {results.map((match, index) => {
                        const piso = pisos.find(p => p.id === match.piso_id);
                        if (!piso) return null;
                        
                        return (
                          <tr key={match.piso_id} className="hover:bg-gray-50">
                            <td className="border border-gray-300 px-3 py-2">
                              <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                match.score >= 90 ? 'bg-green-100 text-green-800' :
                                match.score >= 80 ? 'bg-blue-100 text-blue-800' :
                                match.score >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                              }`}>
                                {match.score}%
                              </span>
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {piso.direccion || `Piso ID: ${piso.id}`}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{piso.zona}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{piso.subzonas || 'N/A'}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.precio?.toLocaleString() + '€', match.penalizaciones, 'precio')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.m2 + 'm²', match.penalizaciones, 'm2')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.tipo_vivienda, match.penalizaciones, 'tipo_vivienda')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{piso.habitaciones || 'N/A'}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.estado, match.penalizaciones, 'estado')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.ascensor, match.penalizaciones, 'ascensor')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.bajos, match.penalizaciones, 'bajos')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.entreplanta, match.penalizaciones, 'entreplanta')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">{piso.planta || 'N/A'}</td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.altura, match.penalizaciones, 'altura')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.cercania_metro, match.penalizaciones, 'cercania_metro')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.balcon_terraza, match.penalizaciones, 'balcon_terraza')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.patio, match.penalizaciones, 'patio')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 whitespace-nowrap text-sm">
                              {getStyledCellContent(piso.interior, match.penalizaciones, 'interior')}
                            </td>
                            <td className="border border-gray-300 px-3 py-2 max-w-xs text-sm overflow-hidden text-ellipsis">
                              {piso.caracteristicas_adicionales || 'N/A'}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
            
            {results.length === 0 && selectedCliente && !loading && (
              <div className="text-center py-8 text-gray-500">
                No se encontraron pisos compatibles para este cliente.
              </div>
            )}
          </div>
        </div>
      );
    };
    // ✅ COMPONENTE DE GESTIÓN DE CLIENTES - CORREGIDO
    // ✅ COMPONENTE DE GESTIÓN DE CLIENTES - CORREGIDO
    const ClientesManagement = ({ userRole }) => {
      const [clientes, setClientes] = useState([]);
      const [asesores, setAsesores] = useState([]);
      const [loading, setLoading] = useState(true);
      const [editingCliente, setEditingCliente] = useState(null);
      const [showEditModal, setShowEditModal] = useState(false);
      // ✅ NUEVO: Estado para el buscador
      const [searchPhone, setSearchPhone] = useState('');
    
      // ✅ NUEVO: Función para filtrar clientes por teléfono
      const filteredClientes = clientes.filter(cliente => 
        cliente.telefono.toLowerCase().includes(searchPhone.toLowerCase())
      );
    
      useEffect(() => {
        fetchClientes();
        if (userRole === 'Supervisor') {
          fetchAsesores();
        }
      }, [userRole]);
    
      const fetchClientes = async () => {
        try {
          const response = await fetch(`${API_BASE}/clientes/all`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (response.ok) {
            const data = await response.json();
            setClientes(data);
          }
        } catch (error) {
          console.error("Error fetching clientes:", error);
        } finally {
          setLoading(false);
        }
      };
    
      const fetchAsesores = async () => {
        try {
          const response = await fetch(`${API_BASE}/asesores/`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (response.ok) {
            const data = await response.json();
            setAsesores(data);
          }
        } catch (error) {
          console.error("Error fetching asesores:", error);
        }
      };
    
      const handleEdit = (cliente) => {
        setEditingCliente({
          ...cliente,
          zona: cliente.zona ? cliente.zona.split(',') : [],
          tipo_vivienda: cliente.tipo_vivienda ? cliente.tipo_vivienda.split(',') : [],
          finalidad: cliente.finalidad ? cliente.finalidad.split(',') : [],
          habitaciones: cliente.habitaciones ? cliente.habitaciones.split(',') : [],
          estado: cliente.estado ? cliente.estado.split(',') : [],
          altura: cliente.altura ? cliente.altura.split(',') : []
        });
        setShowEditModal(true);
      };
    
      const handleUpdate = async (updatedCliente) => {
        try {
          const response = await fetch(`${API_BASE}/clientes/${updatedCliente.id}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ...updatedCliente,
              entrada: parseFloat(updatedCliente.entrada),
              precio: parseFloat(updatedCliente.precio),
              m2: parseInt(updatedCliente.m2),
              habitaciones: Array.isArray(updatedCliente.habitaciones) ? updatedCliente.habitaciones.map(Number) : [],
              compania_id: companiaId
            })
          });
    
          if (response.ok) {
            alert('✅ Cliente actualizado exitosamente');
            setShowEditModal(false);
            setEditingCliente(null);
            fetchClientes();
          } else {
            const error = await response.json();
            alert('❌ Error: ' + error.detail);
          }
        } catch (error) {
          alert('❌ Error de conexión: ' + error.message);
        }
      };
    
      const handleDelete = async (clienteId, clienteNombre) => {
        if (confirm(`¿Estás seguro de eliminar el cliente "${clienteNombre}"?\n\nEsta acción no se puede deshacer.`)) {
          try {
            const response = await fetch(`${API_BASE}/clientes/${clienteId}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });
    
            if (response.ok) {
              alert('✅ Cliente eliminado exitosamente');
              fetchClientes();
            } else {
              const error = await response.json();
              alert('❌ Error: ' + error.detail);
            }
          } catch (error) {
            alert('❌ Error de conexión: ' + error.message);
          }
        }
      };
    
      const handleReasignar = async (clienteId, nuevoAsesorId) => {
        try {
          const response = await fetch(`${API_BASE}/asesores/reasignar-cliente`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              cliente_id: clienteId,
              nuevo_asesor_id: parseInt(nuevoAsesorId)
            })
          });
    
          if (response.ok) {
            alert('✅ Cliente reasignado exitosamente');
            fetchClientes();
          } else {
            const error = await response.json();
            alert('❌ Error: ' + error.detail);
          }
        } catch (error) {
          alert('❌ Error de conexión: ' + error.message);
        }
      };
    
      if (loading) {
        return <div className="text-center py-8">Cargando clientes...</div>;
      }
    
      return (
        <div className="section-card p-8">
          <div className="mb-6">
            <div className="flex justify-between items-center mb-4">
              <div>
                <h2 className="text-2xl font-semibold text-gray-900 mb-2">
                  👥 Gestión de Clientes {userRole === 'Supervisor' ? '(Todos)' : '(Mis Clientes)'}
                </h2>
                <p className="text-gray-600">
                  {userRole === 'Supervisor' 
                    ? 'Gestiona todos los clientes de la compañía' 
                    : 'Gestiona tus clientes asignados'
                  }
                </p>
              </div>
              
              {/* ✅ NUEVO: Buscador por teléfono */}
              <div className="flex items-center space-x-2">
                <div className="relative">
                  <input
                    type="text"
                    placeholder="🔍 Buscar por teléfono..."
                    value={searchPhone}
                    onChange={(e) => setSearchPhone(e.target.value)}
                    className="form-input w-64 pl-4 pr-4 py-2 text-sm border-2 border-gray-200 rounded-lg focus:border-blue-500"
                  />
                  {searchPhone && (
                    <button
                      onClick={() => setSearchPhone('')}
                      className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                    >
                      ✕
                    </button>
                  )}
                </div>
                {searchPhone && (
                  <span className="text-sm text-gray-500">
                    {filteredClientes.length} resultado{filteredClientes.length !== 1 ? 's' : ''}
                  </span>
                )}
              </div>
            </div>
          </div>
          
          <div className="space-y-4">
            {filteredClientes.map(cliente => (
              <div key={cliente.id} className="p-4 bg-white border border-gray-200 rounded-lg">
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <h3 className="font-semibold text-lg text-gray-900">{cliente.nombre}</h3>
                    <div className="text-sm text-gray-600 mt-1 space-y-1">
                      <div>📞 {cliente.telefono}</div>
                      <div>🏠 {cliente.zona} | 💰 {cliente.precio?.toLocaleString()}€</div>
                      <div>📐 {cliente.m2}m² | 🛏️ {cliente.habitaciones} hab.</div>
                      <div>🏦 {cliente.banco || 'Sin banco'} | 🔑 {cliente.kiron || 'Sin KÍRON'}</div>
                    </div>
                  </div>
                  
                  <div className="ml-4 text-right space-y-2">
                    {userRole === 'Supervisor' && (
                      <div className="mb-2">
                        <span className="text-sm font-medium text-gray-700">Asesor:</span>
                        <div className="text-blue-600 font-medium text-sm">
                          {cliente.asesor_asignado ? cliente.asesor_asignado.email : 'Sin asignar'}
                        </div>
                      </div>
                    )}
                    
                    <div className="flex flex-col space-y-2">
                      <button
                        onClick={() => handleEdit(cliente)}
                        className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors"
                      >
                        ✏️ Editar
                      </button>
                      
                      <button
                        onClick={() => handleDelete(cliente.id, cliente.nombre)}
                        className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors"
                      >
                        🗑️ Eliminar
                      </button>
                      
                      {userRole === 'Supervisor' && (
                        <select
                          className="text-xs border border-gray-300 rounded px-2 py-1"
                          defaultValue={cliente.asesor_id || ''}
                          onChange={(e) => {
                            if (e.target.value && e.target.value !== cliente.asesor_id?.toString()) {
                              if (confirm('¿Confirmar reasignación del cliente?')) {
                                handleReasignar(cliente.id, e.target.value);
                              } else {
                                e.target.value = cliente.asesor_id || '';
                              }
                            }
                          }}
                        >
                          <option value="">Reasignar...</option>
                          {asesores.map(asesor => (
                            <option key={asesor.id} value={asesor.id}>
                              {asesor.email} ({asesor.clientes_count})
                            </option>
                          ))}
                        </select>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ))}
            
            {filteredClientes.length === 0 && searchPhone && (
              <div className="text-center py-8 text-gray-500">
                No se encontraron clientes con el teléfono "{searchPhone}".
              </div>
            )}
            
            {clientes.length === 0 && !searchPhone && (
              <div className="text-center py-8 text-gray-500">
                No hay clientes registrados.
              </div>
            )}
          </div>
    
          {/* Modal de Edición */}
          {showEditModal && editingCliente && (
            <ClienteEditModal
              cliente={editingCliente}
              onSave={handleUpdate}
              onCancel={() => {
                setShowEditModal(false);
                setEditingCliente(null);
              }}
            />
          )}
        </div>
      );
    };
    
    // ✅ COMPONENTE DE GESTIÓN DE PISOS - COMPLETO Y CORREGIDO
    const PisosManagement = () => {
      const [pisos, setPisos] = useState([]);
      const [loading, setLoading] = useState(true);
      const [editingPiso, setEditingPiso] = useState(null);
      const [showEditModal, setShowEditModal] = useState(false);
    
      useEffect(() => {
        fetchPisos();
      }, []);
    
      const fetchPisos = async () => {
        try {
          const response = await fetch(`${API_BASE}/pisos/all`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (response.ok) {
            const data = await response.json();
            setPisos(data);
          }
        } catch (error) {
          console.error("Error fetching pisos:", error);
        } finally {
          setLoading(false);
        }
      };
    
      const handleEdit = (piso) => {
        setEditingPiso({
          ...piso,
          zona: piso.zona ? [piso.zona] : [],
          tipo_vivienda: piso.tipo_vivienda ? piso.tipo_vivienda.split(',') : []
        });
        setShowEditModal(true);
      };
    
      const handleUpdate = async (updatedPiso) => {
        try {
          const response = await fetch(`${API_BASE}/pisos/${updatedPiso.id}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ...updatedPiso,
              precio: parseFloat(updatedPiso.precio),
              m2: parseInt(updatedPiso.m2),
              habitaciones: updatedPiso.habitaciones ? [parseInt(updatedPiso.habitaciones)] : [],
              compania_id: companiaId
            })
          });
    
          if (response.ok) {
            alert('✅ Piso actualizado exitosamente');
            setShowEditModal(false);
            setEditingPiso(null);
            fetchPisos();
          } else {
            const error = await response.json();
            alert('❌ Error: ' + error.detail);
          }
        } catch (error) {
          alert('❌ Error de conexión: ' + error.message);
        }
      };
    
      const handleDelete = async (pisoId, pisoInfo) => {
        if (confirm(`¿Estás seguro de eliminar el piso "${pisoInfo}"?\n\nEsta acción no se puede deshacer.`)) {
          try {
            const response = await fetch(`${API_BASE}/pisos/${pisoId}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });
    
            if (response.ok) {
              alert('✅ Piso eliminado exitosamente');
              fetchPisos();
            } else {
              const error = await response.json();
              alert('❌ Error: ' + error.detail);
            }
          } catch (error) {
            alert('❌ Error de conexión: ' + error.message);
          }
        }
      };
    
      if (loading) {
        return <div className="text-center py-8">Cargando pisos...</div>;
      }
    
      return (
        <div className="section-card p-8">
          <div className="mb-6">
            <h2 className="text-2xl font-semibold text-gray-900 mb-2">🏗️ Gestión de Pisos</h2>
            <p className="text-gray-600">Gestiona todas las propiedades de la compañía</p>
          </div>
          
          <div className="space-y-4">
            {pisos.map(piso => (
              <div key={piso.id} className="p-4 bg-white border border-gray-200 rounded-lg">
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <h3 className="font-semibold text-lg text-gray-900">
                      {piso.direccion || `Piso ID: ${piso.id}`}
                    </h3>
                    <div className="text-sm text-gray-600 mt-1 space-y-1">
                      <div>🏠 {piso.zona} | 💰 {piso.precio?.toLocaleString()}€</div>
                      <div>📐 {piso.m2}m² | 🛏️ {piso.habitaciones || 'N/A'} hab.</div>
                      <div>🏢 {piso.tipo_vivienda || 'N/A'} | 🔧 {piso.estado || 'N/A'}</div>
                      <div>🚇 {piso.cercania_metro || 'N/A'} | 🏗️ Planta {piso.planta || 'N/A'}</div>
                    </div>
                  </div>
                  
                  <div className="ml-4 text-right space-y-2">
                    <div className="flex flex-col space-y-2">
                      <button
                        onClick={() => handleEdit(piso)}
                        className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors"
                      >
                        ✏️ Editar
                      </button>
                      
                      <button
                        onClick={() => handleDelete(piso.id, piso.direccion || `Piso ID: ${piso.id}`)}
                        className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors"
                      >
                        🗑️ Eliminar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            ))}
            
            {pisos.length === 0 && (
              <div className="text-center py-8 text-gray-500">
                No hay pisos registrados.
              </div>
            )}
          </div>
    
          {/* Modal de Edición de Pisos */}
          {showEditModal && editingPiso && (
            <PisoEditModal
              piso={editingPiso}
              onSave={handleUpdate}
              onCancel={() => {
                setShowEditModal(false);
                setEditingPiso(null);
              }}
            />
          )}
        </div>
      );
    };
    
    // ✅ MODAL DE EDICIÓN DE CLIENTE
    // ✅ MODAL DE EDICIÓN DE CLIENTE - COMPLETO CON TODOS LOS PARÁMETROS
    const ClienteEditModal = ({ cliente, onSave, onCancel }) => {
      const [formData, setFormData] = useState(cliente);
    
      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
      };
    
      const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
      };
    
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-6xl max-h-[90vh] overflow-y-auto">
            <h3 className="text-xl font-semibold mb-4">✏️ Editar Cliente: {cliente.nombre}</h3>
            
            <form onSubmit={handleSubmit} className="space-y-6">
              {/* Información Básica */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Información Básica</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                    <input
                      name="nombre"
                      value={formData.nombre}
                      onChange={handleChange}
                      className="w-full form-input"
                      required
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Teléfono *</label>
                    <input
                      name="telefono"
                      value={formData.telefono}
                      onChange={handleChange}
                      className="w-full form-input"
                      required
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Banco</label>
                    <input
                      name="banco"
                      value={formData.banco || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">KÍRON</label>
                    <select
                      name="kiron"
                      value={formData.kiron || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SK">SK</option>
                      <option value="PK">PK</option>
                      <option value="NK">NK</option>
                    </select>
                  </div>
                </div>
              </div>
    
              {/* Ubicación */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Ubicación</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <MultiSelect
                    label="Zona *"
                    name="zona"
                    options={["ALTO", "OLIVOS", "LAGUNA", "BATÁN", "SEPÚLVEDA", "MANZANARES", "PÍO", "PUERTA", "JESUITAS"]}
                    value={formData.zona}
                    onChange={handleChange}
                    required={true}
                  />
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Subzonas</label>
                    <input
                      name="subzonas"
                      value={formData.subzonas || ''}
                      onChange={handleChange}
                      placeholder="Subzonas específicas"
                      className="w-full form-input"
                    />
                  </div>
                </div>
              </div>
    
              {/* Aspectos Económicos */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Aspectos Económicos</h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Entrada (€) *</label>
                    <input
                      name="entrada"
                      type="number"
                      value={formData.entrada}
                      onChange={handleChange}
                      className="w-full form-input"
                      required
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Precio (€) *</label>
                    <input
                      name="precio"
                      type="number"
                      value={formData.precio}
                      onChange={handleChange}
                      className="w-full form-input"
                      required
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Permuta</label>
                    <select
                      name="permuta"
                      value={formData.permuta || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                  </div>
                </div>
              </div>
    
              {/* Características de la Vivienda */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Características de la Vivienda</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <MultiSelect
                    label="Tipo de Vivienda"
                    name="tipo_vivienda"
                    options={["Piso", "Ático", "Chalet", "Local"]}
                    value={formData.tipo_vivienda}
                    onChange={handleChange}
                  />
                  
                  <MultiSelect
                    label="Finalidad"
                    name="finalidad"
                    options={["Primera Vivienda", "Inversión"]}
                    value={formData.finalidad}
                    onChange={handleChange}
                  />
                  
                  <MultiSelect
                    label="Habitaciones"
                    name="habitaciones"
                    options={["0", "1", "2", "3", "4", "5"]}
                    value={formData.habitaciones}
                    onChange={handleChange}
                  />
                  
                  <MultiSelect
                    label="Estado"
                    name="estado"
                    options={["Entrar a Vivir", "Actualizar", "A Reformar"]}
                    value={formData.estado}
                    onChange={handleChange}
                  />
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Metros² *</label>
                    <input
                      name="m2"
                      type="number"
                      value={formData.m2}
                      onChange={handleChange}
                      className="w-full form-input"
                      required
                    />
                  </div>
                </div>
              </div>
    
              {/* Ubicación y Acceso */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Ubicación y Acceso</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Ascensor</label>
                    <select
                      name="ascensor"
                      value={formData.ascensor || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="Después de 1º">Después de 1º</option>
                      <option value="Después de 2º">Después de 2º</option>
                      <option value="Después de 3º">Después de 3º</option>
                      <option value="Después de 4º">Después de 4º</option>
                      <option value="Después de 5º">Después de 5º</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Bajos</label>
                    <select
                      name="bajos"
                      value={formData.bajos || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Entreplanta</label>
                    <select
                      name="entreplanta"
                      value={formData.entreplanta || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                  </div>
                  
                  <MultiSelect
                    label="Altura"
                    name="altura"
                    options={["PRIMERAS PLANTAS", "PLANTAS INTERMEDIAS", "ÚLTIMAS PLANTAS"]}
                    value={formData.altura}
                    onChange={handleChange}
                  />
                </div>
              </div>
    
              {/* Transporte */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Transporte</h4>
                <div className="grid grid-cols-1 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Cercanía Metro</label>
                    <select
                      name="cercania_metro"
                      value={formData.cercania_metro || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="0-5 MIN">0-5 MIN</option>
                      <option value="5-10 MIN">5-10 MIN</option>
                      <option value="10-15 MIN">10-15 MIN</option>
                      <option value="15-20 MIN">15-20 MIN</option>
                      <option value="+20 MIN">+20 MIN</option>
                    </select>
                  </div>
                </div>
              </div>
    
              {/* Espacios Exteriores */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Espacios Exteriores</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Balcón/Terraza</label>
                    <select
                      name="balcon_terraza"
                      value={formData.balcon_terraza || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="INDIFERENTE">INDIFERENTE</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Patio</label>
                    <select
                      name="patio"
                      value={formData.patio || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="INDIFERENTE">INDIFERENTE</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Interior</label>
                    <select
                      name="interior"
                      value={formData.interior || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="EXTERIOR">EXTERIOR</option>
                      <option value="INTERIOR">INTERIOR</option>
                      <option value="INDIFERENTE">INDIFERENTE</option>
                    </select>
                  </div>
                </div>
              </div>
    
              {/* Información Adicional */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Información Adicional</h4>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Características Adicionales</label>
                  <textarea
                    name="caracteristicas_adicionales"
                    value={formData.caracteristicas_adicionales || ''}
                    onChange={handleChange}
                    placeholder="Detalles adicionales sobre las preferencias del cliente..."
                    rows="4"
                    className="w-full form-input"
                  />
                </div>
              </div>
              
              <div className="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                <button
                  type="button"
                  onClick={onCancel}
                  className="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-6 py-2 btn-primary"
                >
                  ✅ Guardar Cambios
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };
    
    // ✅ MODAL DE EDICIÓN DE PISO
    // ✅ MODAL DE EDICIÓN DE PISO - COMPLETO CON TODOS LOS PARÁMETROS
    const PisoEditModal = ({ piso, onSave, onCancel }) => {
      const [formData, setFormData] = useState(piso);
    
      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
      };
    
      const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
      };
    
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-6xl max-h-[90vh] overflow-y-auto">
            <h3 className="text-xl font-semibold mb-4">
              ✏️ Editar Piso: {piso.direccion || `ID ${piso.id}`}
            </h3>
            
            <form onSubmit={handleSubmit} className="space-y-6">
              {/* Información Básica */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Información Básica</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                    <input
                      name="direccion"
                      value={formData.direccion || ''}
                      onChange={handleChange}
                      placeholder="Dirección completa"
                      className="w-full form-input"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Zona *</label>
                    <select
                      name="zona"
                      value={formData.zona || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                      required
                    >
                      <option value="">Seleccionar zona</option>
                      <option value="ALTO">ALTO</option>
                      <option value="OLIVOS">OLIVOS</option>
                      <option value="LAGUNA">LAGUNA</option>
                      <option value="BATÁN">BATÁN</option>
                      <option value="SEPÚLVEDA">SEPÚLVEDA</option>
                      <option value="MANZANARES">MANZANARES</option>
                      <option value="PÍO">PÍO</option>
                      <option value="PUERTA">PUERTA</option>
                      <option value="JESUITAS">JESUITAS</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Subzonas</label>
                    <input
                      name="subzonas"
                      value={formData.subzonas || ''}
                      onChange={handleChange}
                      placeholder="Subzonas específicas"
                      className="w-full form-input"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Precio (€) *</label>
                    <input
                      name="precio"
                      type="number"
                      value={formData.precio}
                      onChange={handleChange}
                      placeholder="Precio en euros"
                      className="w-full form-input"
                      required
                    />
                  </div>
                </div>
              </div>
    
              {/* Características de la Vivienda */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Características de la Vivienda</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <MultiSelect
                    label="Tipo de Vivienda"
                    name="tipo_vivienda"
                    options={["Piso", "Ático", "Chalet", "Local"]}
                    value={formData.tipo_vivienda}
                    onChange={handleChange}
                  />
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Habitaciones</label>
                    <select
                      name="habitaciones"
                      value={formData.habitaciones || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar habitaciones</option>
                      <option value="0">0</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Metros² *</label>
                    <input
                      name="m2"
                      type="number"
                      value={formData.m2}
                      onChange={handleChange}
                      placeholder="Metros cuadrados"
                      className="w-full form-input"
                      required
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                    <select
                      name="estado"
                      value={formData.estado || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar estado</option>
                      <option value="Entrar a Vivir">Entrar a Vivir</option>
                      <option value="Actualizar">Actualizar</option>
                      <option value="A Reformar">A Reformar</option>
                    </select>
                  </div>
                </div>
              </div>
    
              {/* Ubicación y Acceso */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Ubicación y Acceso</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Ascensor</label>
                    <select
                      name="ascensor"
                      value={formData.ascensor || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Bajos</label>
                    <select
                      name="bajos"
                      value={formData.bajos || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Entreplanta</label>
                    <select
                      name="entreplanta"
                      value={formData.entreplanta || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Planta</label>
                    <select
                      name="planta"
                      value={formData.planta || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar planta</option>
                      <option value="-1">-1</option>
                      <option value="0">0</option>
                      <option value="Entreplanta">Entreplanta</option>
                      {[...Array(15).keys()].map(i => (
                        <option key={i + 1} value={i + 1}>{i + 1}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Altura</label>
                    <select
                      name="altura"
                      value={formData.altura || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="PRIMERAS PLANTAS">PRIMERAS PLANTAS</option>
                      <option value="PLANTAS INTERMEDIAS">PLANTAS INTERMEDIAS</option>
                      <option value="ÚLTIMAS PLANTAS">ÚLTIMAS PLANTAS</option>
                    </select>
                  </div>
                </div>
              </div>
    
              {/* Transporte */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Transporte</h4>
                <div className="grid grid-cols-1 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Cercanía Metro</label>
                    <select
                      <select
                        name="cercania_metro"
                        value={formData.cercania_metro || ''}
                        onChange={handleChange}
                        className="w-full form-input"
                      >
                        <option value="">Seleccionar</option>
                        <option value="0-5 MIN">0-5 MIN</option>
                        <option value="5-10 MIN">5-10 MIN</option>
                        <option value="10-15 MIN">10-15 MIN</option>
                        <option value="15-20 MIN">15-20 MIN</option>
                        <option value="+20 MIN">+20 MIN</option>
                      </select>
                  </div>
                </div>
              </div>
    
              {/* Espacios Exteriores */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Espacios Exteriores</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Balcón/Terraza</label>
                    <select
                      name="balcon_terraza"
                      value={formData.balcon_terraza || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Patio</label>
                    <select
                      name="patio"
                      value={formData.patio || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="SÍ">SÍ</option>
                      <option value="NO">NO</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Interior</label>
                    <select
                      name="interior"
                      value={formData.interior || ''}
                      onChange={handleChange}
                      className="w-full form-input"
                    >
                      <option value="">Seleccionar</option>
                      <option value="EXTERIOR">EXTERIOR</option>
                      <option value="INTERIOR">INTERIOR</option>
                      <option value="AMBOS">AMBOS</option>
                    </select>
                  </div>
                </div>
              </div>
    
              {/* Información Adicional */}
              <div className="form-section">
                <h4 className="text-lg font-medium text-gray-900 mb-3">Información Adicional</h4>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Características Adicionales</label>
                  <textarea
                    name="caracteristicas_adicionales"
                    value={formData.caracteristicas_adicionales || ''}
                    onChange={handleChange}
                    placeholder="Detalles adicionales sobre la propiedad..."
                    rows="4"
                    className="w-full form-input"
                  />
                </div>
              </div>
              
              <div className="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                <button
                  type="button"
                  onClick={onCancel}
                  className="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className="px-6 py-2 btn-primary"
                >
                  ✅ Guardar Cambios
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Main App Component
    // Main App Component
    // Nuevo componente para listar todos los clientes (solo Supervisor)
    const ClientesList = () => {
      const [clientes, setClientes] = useState([]);
      const [asesores, setAsesores] = useState([]);
      const [loading, setLoading] = useState(true);
    
      useEffect(() => {
        fetchClientes();
        fetchAsesores();
      }, []);
    
      const fetchClientes = async () => {
        try {
          const response = await fetch(`${API_BASE}/clientes/`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (response.ok) {
            const data = await response.json();
            setClientes(data);
          }
        } catch (error) {
          console.error("Error fetching clientes:", error);
        } finally {
          setLoading(false);
        }
      };
    
      const fetchAsesores = async () => {
        try {
          const response = await fetch(`${API_BASE}/asesores/`, { 
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if (response.ok) {
            const data = await response.json();
            setAsesores(data);
          }
        } catch (error) {
          console.error("Error fetching asesores:", error);
        }
      };
    
      const handleReasignar = async (clienteId, nuevoAsesorId) => {
        try {
          const response = await fetch(`${API_BASE}/asesores/reasignar-cliente`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              cliente_id: clienteId,
              nuevo_asesor_id: parseInt(nuevoAsesorId)
            })
          });
    
          if (response.ok) {
            alert('✅ Cliente reasignado exitosamente');
            fetchClientes();
          } else {
            const error = await response.json();
            alert('❌ Error: ' + error.detail);
          }
        } catch (error) {
          alert('❌ Error de conexión: ' + error.message);
        }
      };
    
      if (loading) {
        return <div className="text-center py-8">Cargando clientes...</div>;
      }
    
      return (
        <div className="section-card p-8">
          <div className="mb-6">
            <h2 className="text-2xl font-semibold text-gray-900 mb-2">👥 Gestión de Clientes</h2>
            <p className="text-gray-600">Todos los clientes de la compañía y sus asesores asignados</p>
          </div>
          
          <div className="space-y-4">
            {clientes.map(cliente => {
              const asesor = asesores.find(a => a.id === cliente.asesor_id);
              return (
                <div key={cliente.id} className="p-4 bg-white border border-gray-200 rounded-lg">
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <h3 className="font-semibold text-lg text-gray-900">{cliente.nombre}</h3>
                      <div className="text-sm text-gray-600 mt-1 space-y-1">
                        <div>📞 {cliente.telefono}</div>
                        <div>🏠 {cliente.zona} | 💰 {cliente.precio?.toLocaleString()}€</div>
                        <div>📐 {cliente.m2}m² | 🛏️ {cliente.habitaciones} hab.</div>
                      </div>
                    </div>
                    
                    <div className="ml-4 text-right">
                      <div className="mb-2">
                        <span className="text-sm font-medium text-gray-700">Asesor asignado:</span>
                        <div className="text-blue-600 font-medium">
                          {asesor ? asesor.email : 'Sin asignar'}
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        <select
                          className="text-sm border border-gray-300 rounded px-2 py-1"
                          defaultValue={cliente.asesor_id || ''}
                          onChange={(e) => {
                            if (e.target.value && e.target.value !== cliente.asesor_id?.toString()) {
                              if (confirm('¿Confirmar reasignación del cliente?')) {
                                handleReasignar(cliente.id, e.target.value);
                              } else {
                                e.target.value = cliente.asesor_id || '';
                              }
                            }
                          }}
                        >
                          <option value="">Seleccionar asesor...</option>
                          {asesores.map(asesor => (
                            <option key={asesor.id} value={asesor.id}>
                              {asesor.email} ({asesor.clientes_count} clientes)
                            </option>
                          ))}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
            
            {clientes.length === 0 && (
              <div className="text-center py-8 text-gray-500">
                No hay clientes registrados en esta compañía.
              </div>
            )}
          </div>
        </div>
      );
    };
    const App = () => {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [activeSection, setActiveSection] = useState('clientes');
      const [userRole, setUserRole] = useState(null);
    
      const handleLogin = () => {
        // Extraer rol del token
        if (token) {
          const payload = JSON.parse(atob(token.split(".")[1]));
          setUserRole(payload.rol);
        }
        setIsLoggedIn(true);
      };

      const handleRegister = () => {
        // Refresh data after registration if needed
      };

      const renderActiveSection = () => {
        switch(activeSection) {
          case 'clientes':
            return <ClientForm onRegister={handleRegister} userRole={userRole} />;
          case 'pisos':
            return <PisoForm onRegister={handleRegister} />;
          case 'searchClientes':
            return <SearchClientes userRole={userRole} />;
          case 'searchPisos':
            return <SearchPisos />;
          case 'gestionClientes':
            return <ClientesManagement userRole={userRole} />;
          case 'gestionPisos':
            return userRole === 'Supervisor' ? <PisosManagement /> : <div className="text-center py-8 text-red-500">Acceso denegado - Solo Supervisores</div>;
          default:
            return <ClientForm onRegister={handleRegister} userRole={userRole} />;
        }
      };

      if (!isLoggedIn) {
        return <LoginForm onLogin={handleLogin} />;
      }

      return (
        <div className="flex min-h-screen bg-gray-50">
          <Sidebar activeSection={activeSection} setActiveSection={setActiveSection} userRole={userRole} />
          
          <div className="flex-1 ml-72">
            <div className="p-8">
              <div className="mb-8">
                <h1 className="text-3xl font-bold text-gray-900 mb-2">
                  Dashboard
                </h1>
                <p className="text-gray-600">
                  Gestiona clientes y propiedades con inteligencia artificial
                </p>
              </div>
              
              {renderActiveSection()}
            </div>
          </div>
        </div>
      );
    };

    // AGREGAR ESTAS FUNCIONES AL FINAL DEL SCRIPT EN index.html, ANTES DE ReactDOM.render

    // Función para convertir JSON a Excel y descargar
    const downloadExcel = (data, filename) => {
      // Convertir datos a formato CSV
      if (!data || data.length === 0) {
        alert('No hay datos para exportar');
        return;
      }
      
      // Obtener headers de las columnas
      const headers = Object.keys(data[0]);
      
      // Crear contenido CSV
      let csvContent = headers.join(',') + '\n';
      
      data.forEach(row => {
        const values = headers.map(header => {
          let value = row[header] || '';
          // Escapar comillas y agregar comillas si contiene comas
          if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
            value = '"' + value.replace(/"/g, '""') + '"';
          }
          return value;
        });
        csvContent += values.join(',') + '\n';
      });
      
      // Crear blob y descargar
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    };
    
    // Función para descargar reporte de matches
    const downloadMatchesReport = async () => {
      try {
        const response = await fetch(`${API_BASE}/match/download-excel`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          const filename = `matches_report_${new Date().toISOString().split('T')[0]}.csv`;
          downloadExcel(data.datos, filename);
          alert(`✅ Reporte descargado: ${data.total_registros} registros`);
        } else {
          const error = await response.json();
          alert('❌ Error: ' + error.detail);
        }
      } catch (error) {
        console.error('Error downloading report:', error);
        alert('❌ Error de conexión al descargar reporte');
      }
    };

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
