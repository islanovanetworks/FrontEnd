<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MatchingProps</title>
  <style>
    body { background-color: #2d3436; color: white; font-family: 'Segoe UI', sans-serif; }
    .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    input, select { background-color: white; color: black; padding: 5px; border-radius: 5px; }
    button { background-color: #f9ca24; color: black; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #f1c40f; }
    #actions a { color: #f9ca24; text-decoration: none; }
    #actions a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="container" class="max-w-6xl mx-auto p-8">
    <h1 style="text-align: center; font-size: 2.5rem;">üè† MatchingProps</h1>
    <div id="loginForm" style="display: block;">
      <h2>Iniciar sesi√≥n</h2>
      <form id="login">
        <input type="email" id="email" placeholder="Email" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button type="submit">Entrar</button>
      </form>
    </div>
    <div id="mainApp" style="display: none;">
      <div id="actions">
        <h2>üîé Acciones disponibles</h2>
        <ul>
          <li><a href="#clienteForm">üßç Registrar Cliente</a></li>
          <li><a href="#pisoForm">üè° Registrar Piso</a></li>
          <li><a href="#searchClientes">üîç Buscar Clientes</a></li>
          <li><a href="#searchPisos">üè° Buscar Pisos</a></li>
        </ul>
      </div>
      <div id="clienteForm" class="form-grid">
        <h2>üßç Registro de nuevo cliente</h2>
        <input type="text" id="nombre" placeholder="Nombre" required><br>
        <input type="tel" id="telefono" placeholder="Tel√©fono" required><br>
        <select id="zona" multiple required>
          <option value="ALTO">ALTO</option>
          <option value="OLIVOS">OLIVOS</option>
          <option value="LAGUNA">LAGUNA</option>
          <option value="BAT√ÅN">BAT√ÅN</option>
          <option value="SEP√öLVEDA">SEP√öLVEDA</option>
          <option value="MANZANARES">MANZANARES</option>
          <option value="P√çO">P√çO</option>
          <option value="PUERTA">PUERTA</option>
          <option value="JESUITAS">JESUITAS</option>
        </select><br>
        <input type="text" id="subzonas" placeholder="Subzonas"><br>
        <select id="entrada" required>
          <option value="">Seleccionar Entrada</option>
          <!-- ‚Ç¨10,000 to ‚Ç¨500,000 in ‚Ç¨10,000 increments -->
          <option value="10000">10,000‚Ç¨</option>
          <option value="20000">20,000‚Ç¨</option>
          <option value="30000">30,000‚Ç¨</option>
          <option value="40000">40,000‚Ç¨</option>
          <option value="50000">50,000‚Ç¨</option>
          <option value="60000">60,000‚Ç¨</option>
          <option value="70000">70,000‚Ç¨</option>
          <option value="80000">80,000‚Ç¨</option>
          <option value="90000">90,000‚Ç¨</option>
          <option value="100000">100,000‚Ç¨</option>
          <option value="110000">110,000‚Ç¨</option>
          <option value="120000">120,000‚Ç¨</option>
          <option value="130000">130,000‚Ç¨</option>
          <option value="140000">140,000‚Ç¨</option>
          <option value="150000">150,000‚Ç¨</option>
          <option value="160000">160,000‚Ç¨</option>
          <option value="170000">170,000‚Ç¨</option>
          <option value="180000">180,000‚Ç¨</option>
          <option value="190000">190,000‚Ç¨</option>
          <option value="200000">200,000‚Ç¨</option>
          <option value="210000">210,000‚Ç¨</option>
          <option value="220000">220,000‚Ç¨</option>
          <option value="230000">230,000‚Ç¨</option>
          <option value="240000">240,000‚Ç¨</option>
          <option value="250000">250,000‚Ç¨</option>
          <option value="260000">260,000‚Ç¨</option>
          <option value="270000">270,000‚Ç¨</option>
          <option value="280000">280,000‚Ç¨</option>
          <option value="290000">290,000‚Ç¨</option>
          <option value="300000">300,000‚Ç¨</option>
          <option value="310000">310,000‚Ç¨</option>
          <option value="320000">320,000‚Ç¨</option>
          <option value="330000">330,000‚Ç¨</option>
          <option value="340000">340,000‚Ç¨</option>
          <option value="350000">350,000‚Ç¨</option>
          <option value="360000">360,000‚Ç¨</option>
          <option value="370000">370,000‚Ç¨</option>
          <option value="380000">380,000‚Ç¨</option>
          <option value="390000">390,000‚Ç¨</option>
          <option value="400000">400,000‚Ç¨</option>
          <option value="410000">410,000‚Ç¨</option>
          <option value="420000">420,000‚Ç¨</option>
          <option value="430000">430,000‚Ç¨</option>
          <option value="440000">440,000‚Ç¨</option>
          <option value="450000">450,000‚Ç¨</option>
          <option value="460000">460,000‚Ç¨</option>
          <option value="470000">470,000‚Ç¨</option>
          <option value="480000">480,000‚Ç¨</option>
          <option value="490000">490,000‚Ç¨</option>
          <option value="500000">500,000‚Ç¨</option>
        </select><br>
        <select id="precio" required>
          <option value="">Seleccionar Precio</option>
          <!-- ‚Ç¨10,000 to ‚Ç¨200,000 in ‚Ç¨10,000 increments, then ‚Ç¨20,000 -->
          <option value="10000">10,000‚Ç¨</option>
          <option value="20000">20,000‚Ç¨</option>
          <option value="30000">30,000‚Ç¨</option>
          <option value="40000">40,000‚Ç¨</option>
          <option value="50000">50,000‚Ç¨</option>
          <option value="60000">60,000‚Ç¨</option>
          <option value="70000">70,000‚Ç¨</option>
          <option value="80000">80,000‚Ç¨</option>
          <option value="90000">90,000‚Ç¨</option>
          <option value="100000">100,000‚Ç¨</option>
          <option value="110000">110,000‚Ç¨</option>
          <option value="120000">120,000‚Ç¨</option>
          <option value="130000">130,000‚Ç¨</option>
          <option value="140000">140,000‚Ç¨</option>
          <option value="150000">150,000‚Ç¨</option>
          <option value="160000">160,000‚Ç¨</option>
          <option value="170000">170,000‚Ç¨</option>
          <option value="180000">180,000‚Ç¨</option>
          <option value="190000">190,000‚Ç¨</option>
          <option value="200000">200,000‚Ç¨</option>
          <option value="220000">220,000‚Ç¨</option>
          <option value="240000">240,000‚Ç¨</option>
          <option value="260000">260,000‚Ç¨</option>
          <option value="280000">280,000‚Ç¨</option>
          <option value="300000">300,000‚Ç¨</option>
          <option value="320000">320,000‚Ç¨</option>
          <option value="340000">340,000‚Ç¨</option>
          <option value="360000">360,000‚Ç¨</option>
          <option value="380000">380,000‚Ç¨</option>
          <option value="400000">400,000‚Ç¨</option>
          <option value="420000">420,000‚Ç¨</option>
          <option value="440000">440,000‚Ç¨</option>
          <option value="460000">460,000‚Ç¨</option>
          <option value="480000">480,000‚Ç¨</option>
          <option value="500000">500,000‚Ç¨</option>
        </select><br>
        <select id="tipo_vivienda" multiple>
          <option value="Piso">Piso</option>
          <option value="Casa">Casa</option>
          <option value="Chalet">Chalet</option>
          <option value="Adosado">Adosado</option>
          <option value="D√∫plex">D√∫plex</option>
          <option value="√Åtico">√Åtico</option>
          <option value="Estudio">Estudio</option>
        </select><br>
        <select id="finalidad" multiple>
          <option value="Primera Vivienda">Primera Vivienda</option>
          <option value="Inversi√≥n">Inversi√≥n</option>
        </select><br>
        <select id="habitaciones" multiple>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select><br>
        <select id="banos" multiple>
          <option value="1">1</option>
          <option value="1+1">1+1</option>
          <option value="2">2</option>
        </select><br>
        <select id="estado">
          <option value="">Seleccionar</option>
          <option value="Entrar a Vivir">Entrar a Vivir</option>
          <option value="Actualizar">Actualizar</option>
          <option value="A Reformar">A Reformar</option>
        </select><br>
        <select id="ascensor">
          <option value="">Seleccionar</option>
          <option value="S√ç">S√ç</option>
          <option value="HASTA 1¬∫">HASTA 1¬∫</option>
          <option value="HASTA 2¬∫">HASTA 2¬∫</option>
          <option value="HASTA 3¬∫">HASTA 3¬∫</option>
          <option value="HASTA 4¬∫">HASTA 4¬∫</option>
          <option value="HASTA 5¬∫">HASTA 5¬∫</option>
        </select><br>
        <select id="m2">
          <option value="">Seleccionar</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="50">50</option>
          <option value="60">60</option>
          <option value="70">70</option>
          <option value="80">80</option>
          <option value="90">90</option>
          <option value="100">100</option>
          <option value="110">110</option>
          <option value="120">120</option>
          <option value="130">130</option>
          <option value="150">150</option>
        </select><br>
        <select id="orientacion" multiple>
          <option value="Norte">Norte</option>
          <option value="Sur">Sur</option>
          <option value="Este">Este</option>
          <option value="Oeste">Oeste</option>
          <option value="Indiferente">Indiferente</option>
        </select><br>
        <select id="permuta">
          <option value="">Seleccionar</option>
          <option value="S√ç">S√ç</option>
          <option value="NO">NO</option>
        </select><br>
        <button type="button" onclick="registerCliente()">‚úÖ Registrar Cliente</button>
      </div>
      <div id="pisoForm" class="form-grid">
        <h2>üè° Registro de nuevo piso</h2>
        <select id="zonaPiso" multiple required>
          <option value="ALTO">ALTO</option>
          <option value="OLIVOS">OLIVOS</option>
          <option value="LAGUNA">LAGUNA</option>
          <option value="BAT√ÅN">BAT√ÅN</option>
          <option value="SEP√öLVEDA">SEP√öLVEDA</option>
          <option value="MANZANARES">MANZANARES</option>
          <option value="P√çO">P√çO</option>
          <option value="PUERTA">PUERTA</option>
          <option value="JESUITAS">JESUITAS</option>
        </select><br>
        <input type="number" id="precioPiso" placeholder="Precio (‚Ç¨)" required><br>
        <select id="tipo_viviendaPiso" multiple>
          <option value="Piso">Piso</option>
          <option value="Casa">Casa</option>
          <option value="Chalet">Chalet</option>
          <option value="Adosado">Adosado</option>
          <option value="D√∫plex">D√∫plex</option>
          <option value="√Åtico">√Åtico</option>
          <option value="Estudio">Estudio</option>
        </select><br>
        <select id="habitacionesPiso" multiple>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select><br>
        <select id="banosPiso" multiple>
          <option value="1">1</option>
          <option value="1+1">1+1</option>
          <option value="2">2</option>
        </select><br>
        <select id="estadoPiso">
          <option value="">Seleccionar</option>
          <option value="Entrar a Vivir">Entrar a Vivir</option>
          <option value="Actualizar">Actualizar</option>
          <option value="A Reformar">A Reformar</option>
        </select><br>
        <select id="ascensorPiso">
          <option value="">Seleccionar</option>
          <option value="S√ç">S√ç</option>
          <option value="HASTA 1¬∫">HASTA 1¬∫</option>
          <option value="HASTA 2¬∫">HASTA 2¬∫</option>
          <option value="HASTA 3¬∫">HASTA 3¬∫</option>
          <option value="HASTA 4¬∫">HASTA 4¬∫</option>
          <option value="HASTA 5¬∫">HASTA 5¬∫</option>
        </select><br>
        <select id="m2Piso">
          <option value="">Seleccionar</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="50">50</option>
          <option value="60">60</option>
          <option value="70">70</option>
          <option value="80">80</option>
          <option value="90">90</option>
          <option value="100">100</option>
          <option value="110">110</option>
          <option value="120">120</option>
          <option value="130">130</option>
          <option value="150">150</option>
        </select><br>
        <button type="button" onclick="registerPiso()">‚úÖ Registrar Piso</button>
      </div>
      <div id="searchClientes" class="form-grid">
        <h2>üîç Buscar Clientes para un Piso</h2>
        <select id="pisoSelect">
          <option value="">Seleccionar un piso...</option>
        </select><br>
        <button type="button" onclick="searchClientes()">Buscar</button>
        <div id="clientesResult"></div>
      </div>
      <div id="searchPisos" class="form-grid">
        <h2>üè° Buscar Pisos para un Cliente</h2>
        <select id="clienteSelect">
          <option value="">Seleccionar un cliente...</option>
        </select><br>
        <button type="button" onclick="searchPisos()">Buscar</button>
        <div id="pisosResult"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://matchingprops.onrender.com";
    let token = null;
    let companiaId = null;

    document.getElementById("login").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ username: email, password }),
        });
        const data = await response.json();
        if (response.ok) {
          token = data.access_token;
          const payload = JSON.parse(atob(data.access_token.split(".")[1]));
          companiaId = payload.compania_id;
          document.getElementById("loginForm").style.display = "none";
          document.getElementById("mainApp").style.display = "block";
          loadPisos();
          loadClientes();
        } else {
          alert("Login incorrecto: " + data.detail);
        }
      } catch (error) {
        alert("Error en el login: " + error.message);
      }
    });

    async function loadPisos() {
      try {
        const response = await fetch(`${API_BASE}/pisos`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const pisos = await response.json();
        const select = document.getElementById("pisoSelect");
        select.innerHTML = '<option value="">Seleccionar un piso...</option>';
        pisos.forEach(piso => {
          select.innerHTML += `<option value="${piso.id}">Piso ${piso.id} - ${piso.zona} (${piso.precio}‚Ç¨)</option>`;
        });
      } catch (error) {
        alert("Error al cargar pisos: " + error.message);
      }
    }

    async function loadClientes() {
      try {
        const response = await fetch(`${API_BASE}/clientes`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const clientes = await response.json();
        const select = document.getElementById("clienteSelect");
        select.innerHTML = '<option value="">Seleccionar un cliente...</option>';
        clientes.forEach(cliente => {
          select.innerHTML += `<option value="${cliente.id}">${cliente.nombre || "Cliente " + cliente.id} - ${cliente.zona}</option>`;
        });
      } catch (error) {
        alert("Error al cargar clientes: " + error.message);
      }
    }

    async function registerCliente() {
      const cliente = {
        nombre: document.getElementById("nombre").value,
        telefono: document.getElementById("telefono").value,
        zona: Array.from(document.getElementById("zona").selectedOptions).map(opt => opt.value),
        subzonas: document.getElementById("subzonas").value,
        entrada: parseFloat(document.getElementById("entrada").value),
        precio: parseFloat(document.getElementById("precio").value),
        tipo_vivienda: Array.from(document.getElementById("tipo_vivienda").selectedOptions).map(opt => opt.value),
        finalidad: Array.from(document.getElementById("finalidad").selectedOptions).map(opt => opt.value),
        habitaciones: Array.from(document.getElementById("habitaciones").selectedOptions).map(opt => parseInt(opt.value)),
        banos: Array.from(document.getElementById("banos").selectedOptions).map(opt => opt.value),
        estado: document.getElementById("estado").value,
        ascensor: document.getElementById("ascensor").value,
        bajos: document.getElementById("bajos").value,
        entreplanta: document.getElementById("entreplanta").value,
        m2: parseInt(document.getElementById("m2").value),
        altura: document.getElementById("altura").value,
        cercania_metro: document.getElementById("cercania_metro").value,
        orientacion: Array.from(document.getElementById("orientacion").selectedOptions).map(opt => opt.value),
        edificio_semi_nuevo: document.getElementById("edificio_semi_nuevo").value,
        adaptado_movilidad: document.getElementById("adaptado_movilidad").value,
        balcon: document.getElementById("balcon").value,
        patio: document.getElementById("patio").value,
        terraza: document.getElementById("terraza").value,
        garaje: document.getElementById("garaje").value,
        trastero: document.getElementById("trastero").value,
        interior: document.getElementById("interior").value,
        piscina: document.getElementById("piscina").value,
        urbanizacion: document.getElementById("urbanizacion").value,
        vistas: document.getElementById("vistas").value,
        caracteristicas_adicionales: document.getElementById("caracteristicas_adicionales").value,
        banco: document.getElementById("banco").value,
        permuta: document.getElementById("permuta").value,
        compania_id: companiaId
      };
      try {
        const response = await fetch(`${API_BASE}/clientes`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(cliente),
        });
        const result = await response.json();
        if (response.ok) {
          document.getElementById("clientesResult").innerHTML = `<p>Cliente registrado: ${result.nombre}</p>`;
          loadClientes();
          document.getElementById("clienteForm").reset();
        } else {
          alert("Error al registrar cliente: " + result.detail);
        }
      } catch (error) {
        alert("Error al registrar cliente: " + error.message);
      }
    }

    async function registerPiso() {
      const piso = {
        zona: Array.from(document.getElementById("zonaPiso").selectedOptions).map(opt => opt.value),
        precio: parseFloat(document.getElementById("precioPiso").value),
        tipo_vivienda: Array.from(document.getElementById("tipo_viviendaPiso").selectedOptions).map(opt => opt.value),
        habitaciones: Array.from(document.getElementById("habitacionesPiso").selectedOptions).map(opt => parseInt(opt.value)),
        banos: Array.from(document.getElementById("banosPiso").selectedOptions).map(opt => opt.value),
        estado: document.getElementById("estadoPiso").value,
        ascensor: document.getElementById("ascensorPiso").value,
        bajos: document.getElementById("bajos").value,
        entreplanta: document.getElementById("entreplanta").value,
        m2: parseInt(document.getElementById("m2Piso").value),
        altura: document.getElementById("altura").value,
        cercania_metro: document.getElementById("cercania_metro").value,
        orientacion: Array.from(document.getElementById("orientacion").selectedOptions).map(opt => opt.value),
        edificio_semi_nuevo: document.getElementById("edificio_semi_nuevo").value,
        adaptado_movilidad: document.getElementById("adaptado_movilidad").value,
        balcon: document.getElementById("balcon").value,
        patio: document.getElementById("patio").value,
        terraza: document.getElementById("terraza").value,
        garaje: document.getElementById("garaje").value,
        trastero: document.getElementById("trastero").value,
        interior: document.getElementById("interior").value,
        piscina: document.getElementById("piscina").value,
        urbanizacion: document.getElementById("urbanizacion").value,
        vistas: document.getElementById("vistas").value,
        caracteristicas_adicionales: document.getElementById("caracteristicas_adicionales").value,
        compania_id: companiaId
      };
      try {
        const response = await fetch(`${API_BASE}/pisos`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(piso),
        });
        const result = await response.json();
        if (response.ok) {
          document.getElementById("pisosResult").innerHTML = `<p>Piso registrado: ${result.id}</p>`;
          loadPisos();
          document.getElementById("pisoForm").reset();
        } else {
          alert("Error al registrar piso: " + result.detail);
        }
      } catch (error) {
        alert("Error al registrar piso: " + error.message);
      }
    }

    async function searchClientes() {
      const pisoId = document.getElementById("pisoSelect").value;
      if (!pisoId) {
        alert("Selecciona un piso");
        return;
      }
      try {
        const response = await fetch(`${API_BASE}/match?piso_id=${pisoId}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const matches = await response.json();
        let html = "<h3>Clientes compatibles</h3><ul>";
        matches.forEach(match => {
          html += `<li>Cliente ID: ${match.cliente_id} (Score: ${match.score}%)</li>`;
        });
        html += "</ul>";
        document.getElementById("clientesResult").innerHTML = html;
      } catch (error) {
        alert("Error al buscar clientes: " + error.message);
      }
    }

    async function searchPisos() {
      const clienteId = document.getElementById("clienteSelect").value;
      if (!clienteId) {
        alert("Selecciona un cliente");
        return;
      }
      try {
        const response = await fetch(`${API_BASE}/match?cliente_id=${clienteId}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const matches = await response.json();
        let html = "<h3>Pisos compatibles</h3><ul>";
        matches.forEach(match => {
          html += `<li>Piso ID: ${match.piso_id} (Score: ${match.score}%)</li>`;
        });
        html += "</ul>";
        document.getElementById("pisosResult").innerHTML = html;
      } catch (error) {
        alert("Error al buscar pisos: " + error.message);
      }
    }
  </script>
</body>
</html>
